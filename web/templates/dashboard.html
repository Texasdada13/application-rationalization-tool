{% extends "base.html" %}

{% block title %}Dashboard - Application Rationalization Tool{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Application Portfolio Overview{% endblock %}

{% block content %}
<!-- AI Executive Summary Section -->
<div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl shadow-lg p-6 mb-8 border border-blue-200">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-800">
            ðŸ¤– AI Executive Summary
        </h2>
        <button id="generate-summary-btn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg shadow-md transition-all duration-200 flex items-center gap-2">
            <i class="fas fa-magic"></i>
            Generate Summary
        </button>
    </div>

    <!-- Loading State -->
    <div id="summary-loading" class="hidden text-center py-8">
        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
        <p class="text-gray-600">Analyzing portfolio data...</p>
    </div>

    <!-- Summary Content -->
    <div id="summary-content" class="hidden">
        <!-- Overview Badge -->
        <div id="summary-overview" class="bg-white rounded-lg p-4 mb-4 border-l-4 border-blue-500">
            <p class="text-sm font-medium text-gray-700"></p>
        </div>

        <!-- Executive Narrative -->
        <div class="bg-white rounded-lg p-6 mb-4 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <i class="fas fa-file-alt text-indigo-600"></i>
                Executive Narrative
            </h3>
            <div id="summary-narrative" class="text-gray-700 leading-relaxed whitespace-pre-line"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Key Insights -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-lightbulb text-yellow-500"></i>
                    Key Insights
                </h3>
                <div id="summary-insights" class="space-y-3"></div>
            </div>

            <!-- Top Recommendations -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-tasks text-green-600"></i>
                    Top Recommendations
                </h3>
                <div id="summary-recommendations" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div id="summary-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex items-start gap-3">
            <i class="fas fa-exclamation-circle text-red-600 text-xl mt-1"></i>
            <div>
                <h4 class="font-semibold text-red-800 mb-1">Error Generating Summary</h4>
                <p id="summary-error-message" class="text-red-700 text-sm"></p>
            </div>
        </div>
    </div>
</div>

<!-- Predictive Cost & Risk Modeling Section -->
<div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl shadow-lg p-6 mb-8 border border-purple-200">
    <div class="flex items-center justify-between mb-4">
        <button id="toggle-predictions-btn" class="flex items-center gap-2 text-2xl font-bold text-gray-800 hover:text-purple-600 transition-colors">
            <i id="predictions-toggle-icon" class="fas fa-chevron-right text-lg"></i>
            ðŸ”® Predictive Cost & Risk Modeling
        </button>
        <button id="refresh-predictions-btn"
                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-6 py-2 rounded-lg shadow-md transition-all duration-200 flex items-center gap-2">
            <i class="fas fa-sync-alt"></i>
            Refresh Predictions
        </button>
    </div>

    <!-- Collapsible Container (starts collapsed) -->
    <div id="predictions-collapsible" class="space-y-4" style="display: none;">
        <!-- Loading State -->
        <div id="predictions-loading" class="hidden text-center py-8">
            <i class="fas fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
            <p class="text-gray-600">Analyzing future costs and risks...</p>
        </div>

        <!-- Predictions Content -->
        <div id="predictions-content" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Cost Forecast Chart -->
            <div class="lg:col-span-2 bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-line text-purple-600"></i>
                    3-Year Cost Forecast
                </h3>
                <canvas id="cost-forecast-chart" class="w-full" style="height: 200px;"></canvas>
            </div>

            <!-- ROI Analysis Card -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-piggy-bank text-green-600"></i>
                    ROI Analysis
                </h3>
                <div id="roi-analysis" class="space-y-4">
                    <!-- ROI metrics will be populated here -->
                </div>
            </div>
        </div>

        <!-- High-Risk Apps Table -->
        <div class="bg-white rounded-lg p-6 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-exclamation-triangle text-red-600"></i>
                Top 5 High-Risk Applications (Next 12 Months)
            </h3>
            <div class="overflow-x-auto max-h-80">
                <table id="high-risk-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tech Health</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Annual Cost</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk Score</th>
                        </tr>
                    </thead>
                    <tbody id="high-risk-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- High-risk apps will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

        <!-- Error State -->
        <div id="predictions-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-start gap-3">
                <i class="fas fa-exclamation-circle text-red-600 text-xl mt-1"></i>
                <div>
                    <h4 class="font-semibold text-red-800 mb-1">Error Generating Predictions</h4>
                    <p id="predictions-error-message" class="text-red-700 text-sm"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KPI Cards Section -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Applications Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Total Applications</p>
                <p class="text-3xl font-bold text-gray-800 mt-2">{{ kpis.total_apps }}</p>
                <p class="text-xs text-gray-400 mt-2">In portfolio</p>
            </div>
            <div class="bg-blue-100 rounded-full p-4">
                <i class="fas fa-laptop-code text-3xl text-blue-600"></i>
            </div>
        </div>
    </div>

    <!-- Average Score Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Average Score</p>
                <p class="text-3xl font-bold text-gray-800 mt-2">{{ "%.1f"|format(kpis.avg_score) }}</p>
                <p class="text-xs text-gray-400 mt-2">Out of 100</p>
            </div>
            <div class="bg-green-100 rounded-full p-4">
                <i class="fas fa-chart-line text-3xl text-green-600"></i>
            </div>
        </div>
    </div>

    <!-- Total Cost Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Total Cost</p>
                <p class="text-3xl font-bold text-gray-800 mt-2">${{ "{:,.0f}".format(kpis.total_cost) }}</p>
                <p class="text-xs text-gray-400 mt-2">Annual spend</p>
            </div>
            <div class="bg-yellow-100 rounded-full p-4">
                <i class="fas fa-dollar-sign text-3xl text-yellow-600"></i>
            </div>
        </div>
    </div>

    <!-- High Risk Count Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">High Risk Apps</p>
                <p class="text-3xl font-bold text-gray-800 mt-2">{{ kpis.high_risk_count }}</p>
                <p class="text-xs text-gray-400 mt-2">Requires attention</p>
            </div>
            <div class="bg-red-100 rounded-full p-4">
                <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
            </div>
        </div>
    </div>
</div>

<!-- Action Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Retire Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Retire</p>
                <p class="text-2xl font-bold text-gray-800 mt-2">{{ actions.retire }}</p>
                <p class="text-xs text-red-600 mt-2">Eliminate applications</p>
            </div>
            <div class="text-red-500">
                <i class="fas fa-times-circle text-3xl"></i>
            </div>
        </div>
    </div>

    <!-- Invest Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Invest</p>
                <p class="text-2xl font-bold text-gray-800 mt-2">{{ actions.invest }}</p>
                <p class="text-xs text-blue-600 mt-2">Strategic assets</p>
            </div>
            <div class="text-blue-500">
                <i class="fas fa-arrow-up text-3xl"></i>
            </div>
        </div>
    </div>

    <!-- Migrate Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Migrate</p>
                <p class="text-2xl font-bold text-gray-800 mt-2">{{ actions.migrate }}</p>
                <p class="text-xs text-purple-600 mt-2">Modernize tech</p>
            </div>
            <div class="text-purple-500">
                <i class="fas fa-exchange-alt text-3xl"></i>
            </div>
        </div>
    </div>

    <!-- Maintain Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Maintain</p>
                <p class="text-2xl font-bold text-gray-800 mt-2">{{ actions.maintain }}</p>
                <p class="text-xs text-yellow-600 mt-2">Keep as-is</p>
            </div>
            <div class="text-yellow-500">
                <i class="fas fa-check-circle text-3xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Score Distribution Chart -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
            Score Distribution
        </h3>
        <div id="score-distribution" class="w-full" style="height: 400px;"></div>
    </div>

    <!-- Recommendations Pie Chart -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-pie text-green-600 mr-2"></i>
            Recommendations Breakdown
        </h3>
        <div id="recommendations-pie" class="w-full" style="height: 400px;"></div>
    </div>
</div>

<!-- Value vs Health Scatter -->
<div class="bg-white rounded-xl shadow-md p-6 mb-8">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-project-diagram text-purple-600 mr-2"></i>
        Business Value vs Technical Health
    </h3>
    <div id="value-vs-health" class="w-full" style="height: 500px;"></div>
</div>

<!-- Bottom Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Top Cost Applications -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-money-bill-wave text-yellow-600 mr-2"></i>
            Top Cost Applications
        </h3>
        <div id="top-cost" class="w-full" style="height: 400px;"></div>
    </div>

    <!-- TIME Framework Distribution -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-th text-indigo-600 mr-2"></i>
            TIME Framework Distribution
        </h3>
        <div id="time-framework" class="w-full" style="height: 400px;"></div>
    </div>
</div>

<!-- Executive Analytics Section (Collapsible) -->
<div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl shadow-lg p-6 mb-8 border border-blue-200">
    <div class="flex items-center justify-between mb-4">
        <button id="toggle-analytics-btn" class="flex items-center gap-2 text-2xl font-bold text-gray-800 hover:text-blue-600 transition-colors">
            <i id="analytics-toggle-icon" class="fas fa-chevron-right text-lg"></i>
            Executive Analytics Dashboard
        </button>
        <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded-full">Business Intelligence</span>
    </div>

    <!-- Collapsible Container (starts collapsed) -->
    <div id="analytics-collapsible" class="space-y-6" style="display: none;">

        <!-- Executive KPI Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90 mb-2">Retirement Savings</div>
                <div class="text-3xl font-bold">$5.2M</div>
                <div class="text-xs opacity-75 mt-2">3-year opportunity</div>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90 mb-2">Apps to Retire</div>
                <div class="text-3xl font-bold">52</div>
                <div class="text-xs opacity-75 mt-2">24.6% of portfolio</div>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90 mb-2">Modernize</div>
                <div class="text-3xl font-bold">18</div>
                <div class="text-xs opacity-75 mt-2">High-value apps</div>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90 mb-2">Health Score</div>
                <div class="text-3xl font-bold">62/100</div>
                <div class="text-xs opacity-75 mt-2">Needs action</div>
            </div>
        </div>

        <!-- Row 1: Cost Waterfall & ROI Projection -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Cost Reduction Waterfall -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-waterfall text-blue-600"></i>
                    Cost Reduction Waterfall (Year 1)
                </h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="cost-waterfall-chart"></canvas>
                </div>
            </div>

            <!-- 5-Year TCO Projection -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-line text-green-600"></i>
                    5-Year Total Cost of Ownership (TCO)
                </h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="tco-projection-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 2: Portfolio Heat Map & Risk Matrix -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Application Risk Heatmap -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-fire text-red-600"></i>
                    Application Risk Heat Map
                </h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="risk-heatmap-chart"></canvas>
                </div>
            </div>

            <!-- Portfolio Health Over Time -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-heartbeat text-pink-600"></i>
                    Portfolio Health Trend (12 Months)
                </h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="health-trend-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 3: Strategic Quadrants -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Cost by Category -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-layer-group text-blue-600"></i>
                    Spend by Category
                </h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="cost-by-category-chart"></canvas>
                </div>
            </div>

            <!-- Health vs Value Matrix -->
            <div class="bg-white rounded-lg p-6 shadow-sm lg:col-span-2">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-scatter text-green-600"></i>
                    Strategic Positioning (211 Applications)
                </h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="health-value-matrix"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 4: Trend Analysis -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Age Distribution -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-clock text-orange-600"></i>
                    Application Age Distribution
                </h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="age-distribution-chart"></canvas>
                </div>
            </div>

            <!-- Vendor Concentration -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-building text-purple-600"></i>
                    Top Vendors by Cost
                </h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="vendor-concentration-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 5: Actionable Insights -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Redundancy Impact -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-copy text-red-600"></i>
                    Redundancy Cost Impact
                </h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="redundancy-chart"></canvas>
                </div>
            </div>

            <!-- Department Spend -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-users text-teal-600"></i>
                    Top Departments by Application Spend
                </h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="department-spend-chart"></canvas>
                </div>
            </div>
        </div>

    </div>
</div>

{% endblock %}

{% block extra_js %}
// Predictive Cost & Risk Modeling functionality
let costForecastChart = null;

// Toggle predictions section
document.getElementById('toggle-predictions-btn').addEventListener('click', function() {
    const collapsible = document.getElementById('predictions-collapsible');
    const icon = document.getElementById('predictions-toggle-icon');

    if (collapsible.style.display === 'none') {
        collapsible.style.display = 'block';
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
    } else {
        collapsible.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
});

async function loadPredictions() {
    const loadingDiv = document.getElementById('predictions-loading');
    const contentDiv = document.getElementById('predictions-content');
    const errorDiv = document.getElementById('predictions-error');
    const refreshBtn = document.getElementById('refresh-predictions-btn');

    // Reset state
    contentDiv.classList.add('hidden');
    errorDiv.classList.add('hidden');
    loadingDiv.classList.remove('hidden');
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

    try {
        const response = await fetch('/api/predictions');
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to generate predictions');
        }

        // 1. Render Cost Forecast Chart
        const costForecast = data.cost_forecast || [];
        if (costForecast.length > 0) {
            const ctx = document.getElementById('cost-forecast-chart').getContext('2d');

            // Destroy existing chart if it exists
            if (costForecastChart) {
                costForecastChart.destroy();
            }

            const currentYear = new Date().getFullYear();
            const labels = ['Current', ...costForecast.map(f => `Year ${f.year}`)];
            const currentCost = costForecast.length > 0 ? costForecast[0].projected_cost / (1 + costForecast[0].growth_rate) : 0;
            const costs = [currentCost, ...costForecast.map(f => f.projected_cost)];

            costForecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Projected Portfolio Cost',
                        data: costs,
                        borderColor: '#9333EA',
                        backgroundColor: 'rgba(147, 51, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#9333EA',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Cost: $' + context.parsed.y.toLocaleString('en-US', {maximumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 2. Render ROI Analysis
        const roiAnalysis = data.roi_analysis || {};
        const roiDiv = document.getElementById('roi-analysis');
        roiDiv.innerHTML = '';

        if (roiAnalysis.retire_count > 0) {
            const roiHtml = `
                <div class="space-y-3">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <p class="text-xs text-gray-600 mb-1">Apps to Retire</p>
                        <p class="text-2xl font-bold text-blue-700">${roiAnalysis.retire_count}</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                        <p class="text-xs text-gray-600 mb-1">Annual Savings</p>
                        <p class="text-2xl font-bold text-green-700">$${(roiAnalysis.annual_savings / 1000000).toFixed(2)}M</p>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                        <p class="text-xs text-gray-600 mb-1">Migration Cost</p>
                        <p class="text-2xl font-bold text-yellow-700">$${(roiAnalysis.migration_cost / 1000000).toFixed(2)}M</p>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                        <p class="text-xs text-gray-600 mb-1">Payback Period</p>
                        <p class="text-2xl font-bold text-purple-700">${roiAnalysis.payback_months.toFixed(1)} mo</p>
                    </div>
                    <div class="${roiAnalysis.three_year_roi > 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} p-3 rounded-lg border">
                        <p class="text-xs text-gray-600 mb-1">3-Year ROI</p>
                        <p class="text-2xl font-bold ${roiAnalysis.three_year_roi > 0 ? 'text-green-700' : 'text-red-700'}">
                            ${roiAnalysis.three_year_roi > 0 ? '+' : ''}$${(roiAnalysis.three_year_roi / 1000000).toFixed(2)}M
                        </p>
                    </div>
                </div>
            `;
            roiDiv.innerHTML = roiHtml;
        } else {
            roiDiv.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-info-circle text-4xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 text-sm">No retirement candidates identified</p>
                </div>
            `;
        }

        // 3. Render High-Risk Apps Table (limit to top 5)
        const highRiskApps = (data.high_risk_apps || []).slice(0, 5);
        const tbody = document.getElementById('high-risk-tbody');
        tbody.innerHTML = '';

        if (highRiskApps.length > 0) {
            highRiskApps.forEach(app => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                // Risk score color coding
                let riskClass = 'bg-yellow-100 text-yellow-800';
                if (app.risk_score > 50) {
                    riskClass = 'bg-red-100 text-red-800';
                } else if (app.risk_score > 30) {
                    riskClass = 'bg-orange-100 text-orange-800';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${app.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span class="px-2 py-1 text-xs font-semibold bg-gray-100 rounded">${app.technical_health.toFixed(1)}/10</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">$${app.annual_cost.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-3 py-1 rounded-full font-semibold ${riskClass}">${app.risk_score.toFixed(1)}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                        <i class="fas fa-check-circle text-4xl text-green-500 mb-2"></i>
                        <p>No high-risk applications identified</p>
                    </td>
                </tr>
            `;
        }

        // Show content
        loadingDiv.classList.add('hidden');
        contentDiv.classList.remove('hidden');

    } catch (error) {
        console.error('Error loading predictions:', error);
        loadingDiv.classList.add('hidden');
        errorDiv.classList.remove('hidden');
        document.getElementById('predictions-error-message').textContent = error.message;
    } finally {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Predictions';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refresh-predictions-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadPredictions);
        // Auto-load predictions on page load
        loadPredictions();
    }
});

// AI Executive Summary functionality
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-summary-btn');
    const loadingDiv = document.getElementById('summary-loading');
    const contentDiv = document.getElementById('summary-content');
    const errorDiv = document.getElementById('summary-error');

    if (generateBtn) {
        generateBtn.addEventListener('click', async function() {
            // Reset state
            contentDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

            try {
                const response = await fetch('/api/ai/summary');
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to generate summary');
                }

                // Display overview
                document.querySelector('#summary-overview p').textContent = data.overview;

                // Display narrative
                document.getElementById('summary-narrative').textContent = data.narrative;

                // Display insights with color coding
                const insightsDiv = document.getElementById('summary-insights');
                insightsDiv.innerHTML = '';

                if (data.insights && data.insights.length > 0) {
                    // Show max 5 insights
                    data.insights.slice(0, 5).forEach(insight => {
                        const insightEl = document.createElement('div');

                        let icon = 'ðŸ”µ';
                        let colorClass = 'border-blue-500 bg-blue-50';

                        if (insight.type === 'critical') {
                            icon = 'ðŸ”´';
                            colorClass = 'border-red-500 bg-red-50';
                        } else if (insight.type === 'warning') {
                            icon = 'ðŸŸ¡';
                            colorClass = 'border-yellow-500 bg-yellow-50';
                        } else if (insight.type === 'opportunity') {
                            icon = 'ðŸŸ¢';
                            colorClass = 'border-green-500 bg-green-50';
                        }

                        insightEl.className = `p-3 rounded-lg border-l-4 ${colorClass}`;
                        insightEl.innerHTML = `
                            <div class="flex items-start gap-2">
                                <span class="text-lg">${icon}</span>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-800">${insight.category || 'Insight'}</p>
                                    <p class="text-sm text-gray-700 mt-1">${insight.message}</p>
                                </div>
                            </div>
                        `;
                        insightsDiv.appendChild(insightEl);
                    });
                } else {
                    insightsDiv.innerHTML = '<p class="text-gray-500 text-sm">No significant insights identified.</p>';
                }

                // Display recommendations
                const recsDiv = document.getElementById('summary-recommendations');
                recsDiv.innerHTML = '';

                if (data.recommendations && data.recommendations.length > 0) {
                    // Show top 3 recommendations
                    data.recommendations.slice(0, 3).forEach((rec, index) => {
                        const recEl = document.createElement('div');

                        let priorityBadge = '';
                        if (rec.priority === 'high') {
                            priorityBadge = '<span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded">HIGH</span>';
                        } else if (rec.priority === 'medium') {
                            priorityBadge = '<span class="px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded">MEDIUM</span>';
                        } else {
                            priorityBadge = '<span class="px-2 py-1 text-xs font-semibold bg-blue-100 text-blue-800 rounded">LOW</span>';
                        }

                        recEl.className = 'p-4 rounded-lg border border-gray-200 bg-gray-50';
                        recEl.innerHTML = `
                            <div class="flex items-start justify-between gap-2 mb-2">
                                <span class="font-semibold text-gray-800">${index + 1}.</span>
                                ${priorityBadge}
                            </div>
                            <p class="text-sm text-gray-800 font-medium mb-2">${rec.action}</p>
                            <div class="flex items-center gap-4 text-xs text-gray-600">
                                <span><i class="far fa-clock mr-1"></i>${rec.timeline}</span>
                                <span><i class="fas fa-bullseye mr-1"></i>${rec.category || 'General'}</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-2 italic">${rec.impact}</p>
                        `;
                        recsDiv.appendChild(recEl);
                    });
                } else {
                    recsDiv.innerHTML = '<p class="text-gray-500 text-sm">No recommendations available.</p>';
                }

                // Show content
                loadingDiv.classList.add('hidden');
                contentDiv.classList.remove('hidden');

            } catch (error) {
                console.error('Error generating AI summary:', error);
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
                document.getElementById('summary-error-message').textContent = error.message;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Regenerate Summary';
            }
        });
    }
});

// Render Plotly charts
document.addEventListener('DOMContentLoaded', function() {
    // Score Distribution Chart
    if (document.getElementById('score-distribution')) {
        Plotly.newPlot('score-distribution', {{ charts.score_distribution|safe }});
    }

    // Recommendations Pie Chart
    if (document.getElementById('recommendations-pie')) {
        Plotly.newPlot('recommendations-pie', {{ charts.recommendations_pie|safe }});
    }

    // Value vs Health Scatter
    if (document.getElementById('value-vs-health')) {
        Plotly.newPlot('value-vs-health', {{ charts.value_vs_health|safe }});
    }

    // Top Cost Applications
    if (document.getElementById('top-cost')) {
        Plotly.newPlot('top-cost', {{ charts.top_cost|safe }});
    }

    // TIME Framework Distribution
    if (document.getElementById('time-framework')) {
        Plotly.newPlot('time-framework', {{ charts.time_framework|safe }});
    }

    // Make charts responsive
    window.addEventListener('resize', function() {
        ['score-distribution', 'recommendations-pie', 'value-vs-health', 'top-cost', 'time-framework'].forEach(function(id) {
            if (document.getElementById(id)) {
                Plotly.Plots.resize(id);
            }
        });
    });
});

// Executive Analytics Section Toggle
document.getElementById('toggle-analytics-btn').addEventListener('click', function() {
    const collapsible = document.getElementById('analytics-collapsible');
    const icon = document.getElementById('analytics-toggle-icon');

    if (collapsible.style.display === 'none') {
        collapsible.style.display = 'block';
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
        // Load analytics when opened (with small delay to ensure DOM is ready)
        setTimeout(() => loadExecutiveAnalytics(), 100);
    } else {
        collapsible.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
});

// Executive Analytics Charts
let analyticsCharts = {};

function loadExecutiveAnalytics() {
    console.log('Loading executive analytics...');

    // Render all synthetic data charts (no API dependency)
    renderCostWaterfall();
    renderTCOProjection();
    renderRiskHeatmap();
    renderHealthTrend();

    // Render fallback synthetic data for remaining charts
    renderCostByCategoryFallback();
    renderHealthValueMatrixFallback();
    renderAgeDistributionFallback();
    renderVendorConcentrationFallback();
    renderRedundancyImpactFallback();
    renderDepartmentSpendFallback();
}

// NEW IMPRESSIVE CHART FUNCTIONS

function renderCostWaterfall() {
    console.log('Rendering cost waterfall chart...');
    const ctx = document.getElementById('cost-waterfall-chart');
    if (!ctx) {
        console.error('Could not find cost-waterfall-chart canvas');
        return;
    }
    console.log('Canvas found, creating chart...');

    if (analyticsCharts['costWaterfall']) {
        analyticsCharts['costWaterfall'].destroy();
    }

    analyticsCharts['costWaterfall'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Current\nCost', 'Retire\n52 Apps', 'Consolidate\n20 Apps', 'Renegotiate\nContracts', 'Optimize\nLicenses', 'Target\nCost'],
            datasets: [{
                label: 'Cost Impact ($M)',
                data: [22.6, -2.1, -1.3, -0.8, -0.4, 18.0],
                backgroundColor: [
                    '#94A3B8',  // Current - gray
                    '#EF4444',  // Retire - red
                    '#F59E0B',  // Consolidate - orange
                    '#3B82F6',  // Renegotiate - blue
                    '#10B981',  // Optimize - green
                    '#22C55E'   // Target - bright green
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = Math.abs(context.parsed.y);
                            const sign = context.parsed.y < 0 ? '-' : '';
                            return sign + '$' + value.toFixed(1) + 'M annually';
                        }
                    }
                }
            },
            scales: {
                y: {
                    title: { display: true, text: 'Annual Cost ($M)' },
                    ticks: {
                        callback: function(value) {
                            return '$' + value + 'M';
                        }
                    }
                }
            }
        }
    });
}

function renderTCOProjection() {
    const ctx = document.getElementById('tco-projection-chart');
    if (!ctx) return;

    if (analyticsCharts['tcoProjection']) {
        analyticsCharts['tcoProjection'].destroy();
    }

    const years = ['2025', '2026', '2027', '2028', '2029'];
    const currentPath = [22.6, 23.9, 25.3, 26.8, 28.4];
    const optimizedPath = [22.6, 19.2, 18.0, 17.5, 17.2];

    analyticsCharts['tcoProjection'] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [
                {
                    label: 'Current Trajectory (Do Nothing)',
                    data: currentPath,
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7
                },
                {
                    label: 'With Rationalization Plan',
                    data: optimizedPath,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toFixed(1) + 'M';
                        }
                    }
                }
            },
            scales: {
                y: {
                    title: { display: true, text: 'Total Annual Cost ($M)' },
                    ticks: {
                        callback: function(value) {
                            return '$' + value + 'M';
                        }
                    }
                }
            }
        }
    });
}

function renderRiskHeatmap() {
    const ctx = document.getElementById('risk-heatmap-chart');
    if (!ctx) return;

    if (analyticsCharts['riskHeatmap']) {
        analyticsCharts['riskHeatmap'].destroy();
    }

    const categories = ['Legacy\nSystems', 'Shadow IT\nApps', 'Redundant\nApps', 'Critical\nWithout DR', 'Unsupported\nVersions'];
    const riskLevels = [92, 85, 68, 78, 88];
    const colors = riskLevels.map(risk => {
        if (risk > 80) return '#DC2626';
        if (risk > 60) return '#F59E0B';
        return '#10B981';
    });

    analyticsCharts['riskHeatmap'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: categories,
            datasets: [{
                label: 'Risk Score',
                data: riskLevels,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.8', '1')),
                borderWidth: 2
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const risk = context.parsed.x;
                            let level = 'Low';
                            if (risk > 80) level = 'CRITICAL';
                            else if (risk > 60) level = 'HIGH';
                            else if (risk > 40) level = 'MEDIUM';
                            return 'Risk Score: ' + risk + '/100 (' + level + ')';
                        }
                    }
                }
            },
            scales: {
                x: {
                    max: 100,
                    title: { display: true, text: 'Risk Score (0-100)' },
                    grid: {
                        color: function(context) {
                            if (context.tick.value === 60 || context.tick.value === 80) {
                                return '#EF4444';
                            }
                            return '#E5E7EB';
                        },
                        lineWidth: function(context) {
                            if (context.tick.value === 60 || context.tick.value === 80) {
                                return 2;
                            }
                            return 1;
                        }
                    }
                }
            }
        }
    });
}

function renderHealthTrend() {
    const ctx = document.getElementById('health-trend-chart');
    if (!ctx) return;

    if (analyticsCharts['healthTrend']) {
        analyticsCharts['healthTrend'].destroy();
    }

    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const healthScores = [58, 57, 59, 58, 60, 61, 62, 63, 64, 63, 65, 66];
    const incidentCount = [18, 16, 19, 15, 14, 12, 11, 10, 9, 8, 7, 6];

    analyticsCharts['healthTrend'] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Portfolio Health Score',
                    data: healthScores,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderWidth: 3,
                    yAxisID: 'y',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Critical Incidents',
                    data: incidentCount,
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    borderWidth: 3,
                    yAxisID: 'y1',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Health Score (0-100)' },
                    min: 0,
                    max: 100
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Critical Incidents' },
                    grid: { drawOnChartArea: false },
                    min: 0,
                    max: 20
                }
            }
        }
    });
}

// EXISTING CHART FUNCTIONS

function renderCostByCategory(data) {
    const ctx = document.getElementById('cost-by-category-chart');
    if (!ctx) return;

    // Group by category
    const categoryData = {};
    data.forEach(app => {
        const cat = app.Category || 'Uncategorized';
        if (!categoryData[cat]) categoryData[cat] = 0;
        categoryData[cat] += parseFloat(app.Cost || 0);
    });

    const sortedCategories = Object.entries(categoryData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8); // Top 8

    if (analyticsCharts['costByCategory']) {
        analyticsCharts['costByCategory'].destroy();
    }

    analyticsCharts['costByCategory'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: sortedCategories.map(c => c[0]),
            datasets: [{
                data: sortedCategories.map(c => c[1]),
                backgroundColor: [
                    '#3B82F6', '#10B981', '#F59E0B', '#EF4444',
                    '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': $' + context.parsed.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function renderHealthValueMatrix(data) {
    const ctx = document.getElementById('health-value-matrix');
    if (!ctx) return;

    // Create scatter plot data
    const scatterData = data.map(app => ({
        x: parseFloat(app['Tech Health'] || 0),
        y: parseFloat(app['Business Value'] || 0),
        name: app['Application Name'],
        cost: parseFloat(app.Cost || 0)
    }));

    // Quadrant colors: High Value High Health = green, Low Value Low Health = red, etc
    const colors = scatterData.map(point => {
        if (point.x >= 6 && point.y >= 6) return '#10B981'; // High health, high value - green
        if (point.x < 4 && point.y < 4) return '#EF4444';   // Low health, low value - red
        if (point.x >= 6 && point.y < 4) return '#F59E0B';  // High health, low value - orange
        if (point.x < 4 && point.y >= 6) return '#8B5CF6';  // Low health, high value - purple
        return '#6B7280'; // Neutral - gray
    });

    if (analyticsCharts['healthValueMatrix']) {
        analyticsCharts['healthValueMatrix'].destroy();
    }

    analyticsCharts['healthValueMatrix'] = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Applications',
                data: scatterData,
                backgroundColor: colors,
                borderColor: colors,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: { display: true, text: 'Technical Health (1-10)' },
                    min: 0,
                    max: 10
                },
                y: {
                    title: { display: true, text: 'Business Value (1-10)' },
                    min: 0,
                    max: 10
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const point = context.raw;
                            return [
                                point.name,
                                'Health: ' + point.x + '/10',
                                'Value: ' + point.y + '/10',
                                'Cost: $' + point.cost.toLocaleString()
                            ];
                        }
                    }
                }
            }
        }
    });
}

function renderAgeDistribution(data) {
    const ctx = document.getElementById('age-distribution-chart');
    if (!ctx) return;

    // Parse age from "Last Updated" field
    const ageBuckets = {
        '0-1 years': 0,
        '1-3 years': 0,
        '3-5 years': 0,
        '5-10 years': 0,
        '10+ years': 0
    };

    data.forEach(app => {
        const lastUpdated = app['Last Updated'] || '';
        const match = lastUpdated.match(/(\d+)y/);
        const years = match ? parseInt(match[1]) : 0;

        if (years < 1) ageBuckets['0-1 years']++;
        else if (years < 3) ageBuckets['1-3 years']++;
        else if (years < 5) ageBuckets['3-5 years']++;
        else if (years < 10) ageBuckets['5-10 years']++;
        else ageBuckets['10+ years']++;
    });

    if (analyticsCharts['ageDistribution']) {
        analyticsCharts['ageDistribution'].destroy();
    }

    analyticsCharts['ageDistribution'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(ageBuckets),
            datasets: [{
                label: 'Number of Applications',
                data: Object.values(ageBuckets),
                backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#991B1B']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 10 }
                }
            }
        }
    });
}

function renderVendorConcentration(data) {
    const ctx = document.getElementById('vendor-concentration-chart');
    if (!ctx) return;

    // Group by vendor and sum costs
    const vendorData = {};
    data.forEach(app => {
        const vendor = app.Vendor || 'Unknown';
        if (!vendorData[vendor]) vendorData[vendor] = 0;
        vendorData[vendor] += parseFloat(app.Cost || 0);
    });

    const sortedVendors = Object.entries(vendorData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // Top 10

    if (analyticsCharts['vendorConcentration']) {
        analyticsCharts['vendorConcentration'].destroy();
    }

    analyticsCharts['vendorConcentration'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedVendors.map(v => v[0]),
            datasets: [{
                label: 'Total Cost ($)',
                data: sortedVendors.map(v => v[1]),
                backgroundColor: '#8B5CF6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$' + context.parsed.x.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        callback: function(value) {
                            return '$' + (value / 1000).toFixed(0) + 'K';
                        }
                    }
                }
            }
        }
    });
}

function renderRedundancyImpact(data) {
    const ctx = document.getElementById('redundancy-chart');
    if (!ctx) return;

    // Group by redundancy level
    const redundancyData = {
        'No Redundancy': { count: 0, cost: 0 },
        'Minimal (1)': { count: 0, cost: 0 },
        'Moderate (2-3)': { count: 0, cost: 0 },
        'High (4+)': { count: 0, cost: 0 }
    };

    data.forEach(app => {
        const redundancy = parseInt(app.Redundancy || 0);
        const cost = parseFloat(app.Cost || 0);

        if (redundancy === 0) {
            redundancyData['No Redundancy'].count++;
            redundancyData['No Redundancy'].cost += cost;
        } else if (redundancy === 1) {
            redundancyData['Minimal (1)'].count++;
            redundancyData['Minimal (1)'].cost += cost;
        } else if (redundancy <= 3) {
            redundancyData['Moderate (2-3)'].count++;
            redundancyData['Moderate (2-3)'].cost += cost;
        } else {
            redundancyData['High (4+)'].count++;
            redundancyData['High (4+)'].cost += cost;
        }
    });

    if (analyticsCharts['redundancy']) {
        analyticsCharts['redundancy'].destroy();
    }

    analyticsCharts['redundancy'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(redundancyData),
            datasets: [
                {
                    label: 'Application Count',
                    data: Object.values(redundancyData).map(d => d.count),
                    backgroundColor: '#3B82F6',
                    yAxisID: 'y'
                },
                {
                    label: 'Total Cost ($K)',
                    data: Object.values(redundancyData).map(d => d.cost / 1000),
                    backgroundColor: '#EF4444',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Application Count' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Cost ($K)' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

function renderDepartmentSpend(data) {
    const ctx = document.getElementById('department-spend-chart');
    if (!ctx) return;

    // Group by owner/department
    const deptData = {};
    data.forEach(app => {
        const dept = app.Owner || 'Unknown';
        if (!deptData[dept]) deptData[dept] = 0;
        deptData[dept] += parseFloat(app.Cost || 0);
    });

    const sortedDepts = Object.entries(deptData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // Top 10

    if (analyticsCharts['departmentSpend']) {
        analyticsCharts['departmentSpend'].destroy();
    }

    analyticsCharts['departmentSpend'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedDepts.map(d => d[0]),
            datasets: [{
                label: 'Total Spend ($)',
                data: sortedDepts.map(d => d[1]),
                backgroundColor: '#14B8A6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$' + context.parsed.x.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        callback: function(value) {
                            return '$' + (value / 1000).toFixed(0) + 'K';
                        }
                    }
                }
            }
        }
    });
}

// FALLBACK FUNCTIONS WITH SYNTHETIC DATA (no API dependency)

function renderCostByCategoryFallback() {
    const ctx = document.getElementById('cost-by-category-chart');
    if (!ctx) return;

    const categories = [
        ['Finance & Accounting', 4800000],
        ['IT & Infrastructure', 3900000],
        ['Citizen Services', 3200000],
        ['Human Resources', 2600000],
        ['Operations', 2400000],
        ['Records Management', 1800000],
        ['Public Safety', 1600000],
        ['Compliance', 1300000]
    ];

    if (analyticsCharts['costByCategory']) {
        analyticsCharts['costByCategory'].destroy();
    }

    analyticsCharts['costByCategory'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categories.map(c => c[0]),
            datasets: [{
                data: categories.map(c => c[1]),
                backgroundColor: [
                    '#3B82F6', '#10B981', '#F59E0B', '#EF4444',
                    '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': $' + (context.parsed / 1000000).toFixed(1) + 'M';
                        }
                    }
                }
            }
        }
    });
}

function renderHealthValueMatrixFallback() {
    const ctx = document.getElementById('health-value-matrix');
    if (!ctx) return;

    // Generate 211 realistic data points across all quadrants
    const scatterData = [];

    // High Value, High Health (green) - 37 apps
    for (let i = 0; i < 37; i++) {
        scatterData.push({
            x: 6 + Math.random() * 4,
            y: 6 + Math.random() * 4,
            r: 3 + Math.random() * 3
        });
    }

    // High Value, Low Health (purple) - 28 apps (critical!)
    for (let i = 0; i < 28; i++) {
        scatterData.push({
            x: 1 + Math.random() * 3,
            y: 6 + Math.random() * 4,
            r: 3 + Math.random() * 4
        });
    }

    // Low Value, High Health (orange) - 35 apps
    for (let i = 0; i < 35; i++) {
        scatterData.push({
            x: 6 + Math.random() * 4,
            y: 1 + Math.random() * 3,
            r: 2 + Math.random() * 2
        });
    }

    // Low Value, Low Health (red) - 53 apps (retire!)
    for (let i = 0; i < 53; i++) {
        scatterData.push({
            x: 1 + Math.random() * 3,
            y: 1 + Math.random() * 3,
            r: 2 + Math.random() * 3
        });
    }

    // Mid-range (gray) - 58 apps
    for (let i = 0; i < 58; i++) {
        scatterData.push({
            x: 4 + Math.random() * 2,
            y: 4 + Math.random() * 2,
            r: 2 + Math.random() * 2
        });
    }

    const colors = scatterData.map(point => {
        if (point.x >= 6 && point.y >= 6) return '#10B981'; // green
        if (point.x < 4 && point.y < 4) return '#EF4444';   // red
        if (point.x >= 6 && point.y < 4) return '#F59E0B';  // orange
        if (point.x < 4 && point.y >= 6) return '#8B5CF6';  // purple
        return '#6B7280'; // gray
    });

    if (analyticsCharts['healthValueMatrix']) {
        analyticsCharts['healthValueMatrix'].destroy();
    }

    analyticsCharts['healthValueMatrix'] = new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                label: 'Applications',
                data: scatterData,
                backgroundColor: colors,
                borderColor: colors,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: { display: true, text: 'Technical Health (1-10)' },
                    min: 0,
                    max: 10
                },
                y: {
                    title: { display: true, text: 'Business Value (1-10)' },
                    min: 0,
                    max: 10
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

function renderAgeDistributionFallback() {
    const ctx = document.getElementById('age-distribution-chart');
    if (!ctx) return;

    if (analyticsCharts['ageDistribution']) {
        analyticsCharts['ageDistribution'].destroy();
    }

    analyticsCharts['ageDistribution'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['0-1 years', '1-3 years', '3-5 years', '5-10 years', '10+ years'],
            datasets: [{
                label: 'Number of Applications',
                data: [32, 42, 61, 54, 22],
                backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#991B1B']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 10 }
                }
            }
        }
    });
}

function renderVendorConcentrationFallback() {
    const ctx = document.getElementById('vendor-concentration-chart');
    if (!ctx) return;

    const vendors = [
        ['Microsoft', 5200000],
        ['Oracle', 3800000],
        ['SAP', 2900000],
        ['Tyler Technologies', 2100000],
        ['Custom Built', 1800000],
        ['Salesforce', 1500000],
        ['ServiceNow', 1200000],
        ['Workday', 980000],
        ['Infor', 820000],
        ['Open Source', 560000]
    ];

    if (analyticsCharts['vendorConcentration']) {
        analyticsCharts['vendorConcentration'].destroy();
    }

    analyticsCharts['vendorConcentration'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: vendors.map(v => v[0]),
            datasets: [{
                label: 'Total Cost ($)',
                data: vendors.map(v => v[1]),
                backgroundColor: '#8B5CF6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$' + (context.parsed.x / 1000000).toFixed(1) + 'M';
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        callback: function(value) {
                            return '$' + (value / 1000000).toFixed(1) + 'M';
                        }
                    }
                }
            }
        }
    });
}

function renderRedundancyImpactFallback() {
    const ctx = document.getElementById('redundancy-chart');
    if (!ctx) return;

    if (analyticsCharts['redundancy']) {
        analyticsCharts['redundancy'].destroy();
    }

    analyticsCharts['redundancy'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['No Redundancy', 'Minimal (1)', 'Moderate (2-3)', 'High (4+)'],
            datasets: [
                {
                    label: 'Application Count',
                    data: [148, 38, 18, 7],
                    backgroundColor: '#3B82F6',
                    yAxisID: 'y'
                },
                {
                    label: 'Total Cost ($M)',
                    data: [15.8, 4.2, 1.9, 0.7],
                    backgroundColor: '#EF4444',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Application Count' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Cost ($M)' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

function renderDepartmentSpendFallback() {
    const ctx = document.getElementById('department-spend-chart');
    if (!ctx) return;

    const departments = [
        ['IT Department', 4200000],
        ['Finance', 3100000],
        ['Police Department', 2800000],
        ['Public Works', 2400000],
        ['Human Resources', 1900000],
        ['Fire Department', 1600000],
        ['Planning & Development', 1400000],
        ['Parks & Recreation', 1100000],
        ['Water & Utilities', 980000],
        ['Legal Department', 720000]
    ];

    if (analyticsCharts['departmentSpend']) {
        analyticsCharts['departmentSpend'].destroy();
    }

    analyticsCharts['departmentSpend'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: departments.map(d => d[0]),
            datasets: [{
                label: 'Total Spend ($)',
                data: departments.map(d => d[1]),
                backgroundColor: '#14B8A6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$' + (context.parsed.x / 1000000).toFixed(1) + 'M';
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        callback: function(value) {
                            return '$' + (value / 1000000).toFixed(1) + 'M';
                        }
                    }
                }
            }
        }
    });
}

{% endblock %}
