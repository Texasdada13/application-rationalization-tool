{% extends "base.html" %}

{% block title %}Dashboard - Application Rationalization Tool{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Application Portfolio Overview{% endblock %}

{% block content %}
<!-- AI Executive Summary Section -->
<div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl shadow-lg p-6 mb-8 border border-blue-200">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-800">
            ðŸ¤– AI Executive Summary
        </h2>
        <button id="generate-summary-btn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg shadow-md transition-all duration-200 flex items-center gap-2">
            <i class="fas fa-magic"></i>
            Generate Summary
        </button>
    </div>

    <!-- Loading State -->
    <div id="summary-loading" class="hidden text-center py-8">
        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
        <p class="text-gray-600">Analyzing portfolio data...</p>
    </div>

    <!-- Summary Content -->
    <div id="summary-content" class="hidden">
        <!-- Overview Badge -->
        <div id="summary-overview" class="bg-white rounded-lg p-4 mb-4 border-l-4 border-blue-500">
            <p class="text-sm font-medium text-gray-700"></p>
        </div>

        <!-- Executive Narrative -->
        <div class="bg-white rounded-lg p-6 mb-4 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <i class="fas fa-file-alt text-indigo-600"></i>
                Executive Narrative
            </h3>
            <div id="summary-narrative" class="text-gray-700 leading-relaxed whitespace-pre-line"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Key Insights -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-lightbulb text-yellow-500"></i>
                    Key Insights
                </h3>
                <div id="summary-insights" class="space-y-3"></div>
            </div>

            <!-- Top Recommendations -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-tasks text-green-600"></i>
                    Top Recommendations
                </h3>
                <div id="summary-recommendations" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div id="summary-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex items-start gap-3">
            <i class="fas fa-exclamation-circle text-red-600 text-xl mt-1"></i>
            <div>
                <h4 class="font-semibold text-red-800 mb-1">Error Generating Summary</h4>
                <p id="summary-error-message" class="text-red-700 text-sm"></p>
            </div>
        </div>
    </div>
</div>

<!-- Predictive Cost & Risk Modeling Section -->
<div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl shadow-lg p-6 mb-8 border border-purple-200">
    <div class="flex items-center justify-between mb-4">
        <button id="toggle-predictions-btn" class="flex items-center gap-2 text-2xl font-bold text-gray-800 hover:text-purple-600 transition-colors">
            <i id="predictions-toggle-icon" class="fas fa-chevron-right text-lg"></i>
            ðŸ”® Predictive Cost & Risk Modeling
        </button>
        <button id="refresh-predictions-btn"
                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-6 py-2 rounded-lg shadow-md transition-all duration-200 flex items-center gap-2">
            <i class="fas fa-sync-alt"></i>
            Refresh Predictions
        </button>
    </div>

    <!-- Collapsible Container (starts collapsed) -->
    <div id="predictions-collapsible" class="space-y-4" style="display: none;">
        <!-- Loading State -->
        <div id="predictions-loading" class="hidden text-center py-8">
            <i class="fas fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
            <p class="text-gray-600">Analyzing future costs and risks...</p>
        </div>

        <!-- Predictions Content -->
        <div id="predictions-content" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Cost Forecast Chart -->
            <div class="lg:col-span-2 bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-line text-purple-600"></i>
                    3-Year Cost Forecast
                </h3>
                <div style="height: 200px; max-height: 200px; position: relative;">
                    <canvas id="cost-forecast-chart" class="w-full" style="height: 100%;"></canvas>
                </div>
            </div>

            <!-- ROI Analysis Card -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-piggy-bank text-green-600"></i>
                    ROI Analysis
                </h3>
                <div id="roi-analysis" class="space-y-4">
                    <!-- ROI metrics will be populated here -->
                </div>
            </div>
        </div>

        <!-- High-Risk Apps Table -->
        <div class="bg-white rounded-lg p-6 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-exclamation-triangle text-red-600"></i>
                Top 5 High-Risk Applications (Next 12 Months)
            </h3>
            <div class="overflow-x-auto max-h-80">
                <table id="high-risk-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tech Health</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Annual Cost</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk Score</th>
                        </tr>
                    </thead>
                    <tbody id="high-risk-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- High-risk apps will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

        <!-- Error State -->
        <div id="predictions-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-start gap-3">
                <i class="fas fa-exclamation-circle text-red-600 text-xl mt-1"></i>
                <div>
                    <h4 class="font-semibold text-red-800 mb-1">Error Generating Predictions</h4>
                    <p id="predictions-error-message" class="text-red-700 text-sm"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KPI Cards Section -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Applications Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Total Applications</p>
                <p class="text-3xl font-bold text-gray-800 mt-2">{{ kpis.total_apps }}</p>
                <p class="text-xs text-gray-400 mt-2">In portfolio</p>
            </div>
            <div class="bg-blue-100 rounded-full p-4">
                <i class="fas fa-laptop-code text-3xl text-blue-600"></i>
            </div>
        </div>
    </div>

    <!-- Average Score Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Average Score</p>
                <p class="text-3xl font-bold text-gray-800 mt-2">{{ "%.1f"|format(kpis.avg_score) }}</p>
                <p class="text-xs text-gray-400 mt-2">Out of 100</p>
            </div>
            <div class="bg-green-100 rounded-full p-4">
                <i class="fas fa-chart-line text-3xl text-green-600"></i>
            </div>
        </div>
    </div>

    <!-- Total Cost Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Total Cost</p>
                <p class="text-3xl font-bold text-gray-800 mt-2">${{ "{:,.0f}".format(kpis.total_cost) }}</p>
                <p class="text-xs text-gray-400 mt-2">Annual spend</p>
            </div>
            <div class="bg-yellow-100 rounded-full p-4">
                <i class="fas fa-dollar-sign text-3xl text-yellow-600"></i>
            </div>
        </div>
    </div>

    <!-- High Risk Count Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">High Risk Apps</p>
                <p class="text-3xl font-bold text-gray-800 mt-2">{{ kpis.high_risk_count }}</p>
                <p class="text-xs text-gray-400 mt-2">Requires attention</p>
            </div>
            <div class="bg-red-100 rounded-full p-4">
                <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
            </div>
        </div>
    </div>
</div>

<!-- Action Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Retire Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Retire</p>
                <p class="text-2xl font-bold text-gray-800 mt-2">{{ actions.retire }}</p>
                <p class="text-xs text-red-600 mt-2">Eliminate applications</p>
            </div>
            <div class="text-red-500">
                <i class="fas fa-times-circle text-3xl"></i>
            </div>
        </div>
    </div>

    <!-- Invest Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Invest</p>
                <p class="text-2xl font-bold text-gray-800 mt-2">{{ actions.invest }}</p>
                <p class="text-xs text-blue-600 mt-2">Strategic assets</p>
            </div>
            <div class="text-blue-500">
                <i class="fas fa-arrow-up text-3xl"></i>
            </div>
        </div>
    </div>

    <!-- Migrate Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Migrate</p>
                <p class="text-2xl font-bold text-gray-800 mt-2">{{ actions.migrate }}</p>
                <p class="text-xs text-purple-600 mt-2">Modernize tech</p>
            </div>
            <div class="text-purple-500">
                <i class="fas fa-exchange-alt text-3xl"></i>
            </div>
        </div>
    </div>

    <!-- Maintain Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Maintain</p>
                <p class="text-2xl font-bold text-gray-800 mt-2">{{ actions.maintain }}</p>
                <p class="text-xs text-yellow-600 mt-2">Keep as-is</p>
            </div>
            <div class="text-yellow-500">
                <i class="fas fa-check-circle text-3xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Department Executive Scorecards Section -->
<div class="bg-gradient-to-r from-cyan-50 to-sky-50 rounded-xl shadow-lg p-6 mb-8 border border-cyan-200">
    <div class="flex items-center justify-between mb-4">
        <button id="toggle-dept-scorecards-btn" class="flex items-center gap-2 text-2xl font-bold text-gray-800 hover:text-cyan-600 transition-colors">
            <i id="dept-scorecards-toggle-icon" class="fas fa-chevron-right text-lg"></i>
            Department Executive Scorecards
        </button>
        <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded-full">By Business Unit</span>
    </div>

    <!-- Collapsible Container -->
    <div id="dept-scorecards-collapsible" class="space-y-6" style="display: none;">
        <!-- Department Scorecards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="department-scorecards-container">
            <!-- Scorecards will be dynamically generated -->
        </div>

        <!-- Department Comparison Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-bar text-cyan-600"></i>
                    Department Cost Comparison
                </h3>
                <div id="dept-cost-comparison-chart" class="w-full" style="height: 300px;"></div>
            </div>
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-heartbeat text-pink-600"></i>
                    Department Health Scores
                </h3>
                <div id="dept-health-comparison-chart" class="w-full" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Score Distribution Chart -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
            Score Distribution
        </h3>
        <div id="score-distribution" class="w-full" style="height: 400px;"></div>
    </div>

    <!-- Recommendations Pie Chart -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-pie text-green-600 mr-2"></i>
            Recommendations Breakdown
        </h3>
        <div id="recommendations-pie" class="w-full" style="height: 400px;"></div>
    </div>
</div>

<!-- Value vs Health Scatter -->
<div class="bg-white rounded-xl shadow-md p-6 mb-8">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-project-diagram text-purple-600 mr-2"></i>
        Business Value vs Technical Health
    </h3>
    <div id="value-vs-health" class="w-full" style="height: 500px;"></div>
</div>

<!-- Bottom Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Top Cost Applications -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-money-bill-wave text-yellow-600 mr-2"></i>
            Top Cost Applications
        </h3>
        <div id="top-cost" class="w-full" style="height: 400px;"></div>
    </div>

    <!-- TIME Framework Distribution -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-th text-indigo-600 mr-2"></i>
            TIME Framework Distribution
        </h3>
        <div id="time-framework" class="w-full" style="height: 400px;"></div>
    </div>
</div>

<!-- Interactive BI Analytics Section (Switchable Charts) -->
<div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-xl shadow-lg p-6 mb-8 border border-emerald-200">
    <div class="flex items-center justify-between mb-4">
        <button id="toggle-switchable-btn" class="flex items-center gap-2 text-2xl font-bold text-gray-800 hover:text-emerald-600 transition-colors">
            <i id="switchable-toggle-icon" class="fas fa-chevron-right text-lg"></i>
            Interactive BI Analytics
        </button>
        <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded-full">Switchable Visualizations</span>
    </div>

    <!-- Collapsible Container (starts collapsed) -->
    <div id="switchable-collapsible" class="space-y-6" style="display: none;">

        <!-- Row 1: Cost Breakdown & TIME Distribution -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Switchable Cost Breakdown -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-coins text-emerald-600"></i>
                        Cost Breakdown by Category
                    </h3>
                    <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchCostChart('bar')" id="cost-btn-bar" class="chart-switch-btn active px-3 py-1 text-xs font-medium rounded transition-all">Bar</button>
                        <button onclick="switchCostChart('pie')" id="cost-btn-pie" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Pie</button>
                        <button onclick="switchCostChart('treemap')" id="cost-btn-treemap" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Treemap</button>
                    </div>
                </div>
                <div id="switchable-cost-chart" class="w-full" style="height: 350px;"></div>
            </div>

            <!-- Switchable TIME Distribution -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-clock text-blue-600"></i>
                        TIME Framework Analysis
                    </h3>
                    <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchTimeChart('pie')" id="time-btn-pie" class="chart-switch-btn active px-3 py-1 text-xs font-medium rounded transition-all">Pie</button>
                        <button onclick="switchTimeChart('sunburst')" id="time-btn-sunburst" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Sunburst</button>
                        <button onclick="switchTimeChart('donut')" id="time-btn-donut" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Donut</button>
                    </div>
                </div>
                <div id="switchable-time-chart" class="w-full" style="height: 350px;"></div>
            </div>
        </div>

        <!-- Row 2: Risk vs Value & Health Trends -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Switchable Risk vs Value Scatter -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-crosshairs text-purple-600"></i>
                        Risk vs Business Value
                    </h3>
                    <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchRiskChart('scatter')" id="risk-btn-scatter" class="chart-switch-btn active px-3 py-1 text-xs font-medium rounded transition-all">Scatter</button>
                        <button onclick="switchRiskChart('bubble')" id="risk-btn-bubble" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Bubble</button>
                        <button onclick="switchRiskChart('heatmap')" id="risk-btn-heatmap" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Heatmap</button>
                    </div>
                </div>
                <div id="switchable-risk-chart" class="w-full" style="height: 350px;"></div>
            </div>

            <!-- Switchable Health Trends -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-heartbeat text-pink-600"></i>
                        Portfolio Health Trends
                    </h3>
                    <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchHealthChart('line')" id="health-btn-line" class="chart-switch-btn active px-3 py-1 text-xs font-medium rounded transition-all">Line</button>
                        <button onclick="switchHealthChart('area')" id="health-btn-area" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Area</button>
                        <button onclick="switchHealthChart('bar')" id="health-btn-bar" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Bar</button>
                    </div>
                </div>
                <div id="switchable-health-chart" class="w-full" style="height: 350px;"></div>
            </div>
        </div>

        <!-- Row 3: Department Breakdown -->
        <div class="grid grid-cols-1 gap-6">
            <!-- Switchable Department Breakdown -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-sitemap text-orange-600"></i>
                        Department Application Portfolio
                    </h3>
                    <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchDeptChart('treemap')" id="dept-btn-treemap" class="chart-switch-btn active px-3 py-1 text-xs font-medium rounded transition-all">Treemap</button>
                        <button onclick="switchDeptChart('sunburst')" id="dept-btn-sunburst" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Sunburst</button>
                        <button onclick="switchDeptChart('bar')" id="dept-btn-bar" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Bar</button>
                    </div>
                </div>
                <div id="switchable-dept-chart" class="w-full" style="height: 400px;"></div>
            </div>
        </div>

        <!-- Row 4: Cost Savings Realization & Portfolio Evolution -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Cost Savings Realization Tracker -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-piggy-bank text-green-600"></i>
                        Cost Savings Realization
                    </h3>
                    <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchSavingsChart('waterfall')" id="savings-btn-waterfall" class="chart-switch-btn active px-3 py-1 text-xs font-medium rounded transition-all">Waterfall</button>
                        <button onclick="switchSavingsChart('line')" id="savings-btn-line" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Timeline</button>
                        <button onclick="switchSavingsChart('gauge')" id="savings-btn-gauge" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Gauge</button>
                    </div>
                </div>
                <div id="switchable-savings-chart" class="w-full" style="height: 350px;"></div>
            </div>

            <!-- Portfolio Evolution -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-layer-group text-indigo-600"></i>
                        Portfolio Evolution
                    </h3>
                    <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchEvolutionChart('area')" id="evolution-btn-area" class="chart-switch-btn active px-3 py-1 text-xs font-medium rounded transition-all">Stacked</button>
                        <button onclick="switchEvolutionChart('bar')" id="evolution-btn-bar" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Bar</button>
                        <button onclick="switchEvolutionChart('line')" id="evolution-btn-line" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Line</button>
                    </div>
                </div>
                <div id="switchable-evolution-chart" class="w-full" style="height: 350px;"></div>
            </div>
        </div>

        <!-- Row 5: Age vs Cost & Strategic Alignment -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Application Age vs Cost -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-hourglass-half text-amber-600"></i>
                        Application Age vs Cost
                    </h3>
                    <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchAgeCostChart('scatter')" id="agecost-btn-scatter" class="chart-switch-btn active px-3 py-1 text-xs font-medium rounded transition-all">Scatter</button>
                        <button onclick="switchAgeCostChart('bubble')" id="agecost-btn-bubble" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Bubble</button>
                        <button onclick="switchAgeCostChart('bar')" id="agecost-btn-bar" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Bar</button>
                    </div>
                </div>
                <div id="switchable-agecost-chart" class="w-full" style="height: 350px;"></div>
            </div>

            <!-- Strategic Alignment -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-bullseye text-red-600"></i>
                        Strategic Alignment
                    </h3>
                    <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchStrategicChart('radar')" id="strategic-btn-radar" class="chart-switch-btn active px-3 py-1 text-xs font-medium rounded transition-all">Radar</button>
                        <button onclick="switchStrategicChart('bar')" id="strategic-btn-bar" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Bar</button>
                        <button onclick="switchStrategicChart('heatmap')" id="strategic-btn-heatmap" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Matrix</button>
                    </div>
                </div>
                <div id="switchable-strategic-chart" class="w-full" style="height: 350px;"></div>
            </div>
        </div>

        <!-- Row 6: Compliance Heatmap -->
        <div class="grid grid-cols-1 gap-6">
            <!-- Compliance Heatmap Matrix -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-shield-alt text-blue-600"></i>
                        Compliance Framework Matrix
                    </h3>
                    <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchComplianceChart('heatmap')" id="compliance-btn-heatmap" class="chart-switch-btn active px-3 py-1 text-xs font-medium rounded transition-all">Heatmap</button>
                        <button onclick="switchComplianceChart('bar')" id="compliance-btn-bar" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Bar</button>
                        <button onclick="switchComplianceChart('radar')" id="compliance-btn-radar" class="chart-switch-btn px-3 py-1 text-xs font-medium rounded transition-all">Radar</button>
                    </div>
                </div>
                <div id="switchable-compliance-chart" class="w-full" style="height: 400px;"></div>
            </div>
        </div>

    </div>
</div>

<!-- Executive Analytics Section (Collapsible) -->
<div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl shadow-lg p-6 mb-8 border border-blue-200">
    <div class="flex items-center justify-between mb-4">
        <button id="toggle-analytics-btn" class="flex items-center gap-2 text-2xl font-bold text-gray-800 hover:text-blue-600 transition-colors">
            <i id="analytics-toggle-icon" class="fas fa-chevron-right text-lg"></i>
            Executive Analytics Dashboard
        </button>
        <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded-full">Business Intelligence</span>
    </div>

    <!-- Collapsible Container (starts collapsed) -->
    <div id="analytics-collapsible" class="space-y-6" style="display: none;">

        <!-- Executive KPI Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90 mb-2">Retirement Savings</div>
                <div class="text-3xl font-bold">$5.2M</div>
                <div class="text-xs opacity-75 mt-2">3-year opportunity</div>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90 mb-2">Apps to Retire</div>
                <div class="text-3xl font-bold">52</div>
                <div class="text-xs opacity-75 mt-2">24.6% of portfolio</div>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90 mb-2">Modernize</div>
                <div class="text-3xl font-bold">18</div>
                <div class="text-xs opacity-75 mt-2">High-value apps</div>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-6 text-white shadow-lg">
                <div class="text-sm opacity-90 mb-2">Health Score</div>
                <div class="text-3xl font-bold">62/100</div>
                <div class="text-xs opacity-75 mt-2">Needs action</div>
            </div>
        </div>

        <!-- Row 1: Cost Waterfall & ROI Projection -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Cost Reduction Waterfall -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-waterfall text-blue-600"></i>
                    Cost Reduction Waterfall (Year 1)
                </h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="cost-waterfall-chart"></canvas>
                </div>
            </div>

            <!-- 5-Year TCO Projection -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-line text-green-600"></i>
                    5-Year Total Cost of Ownership (TCO)
                </h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="tco-projection-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 2: Portfolio Heat Map & Risk Matrix -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Application Risk Heatmap -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-fire text-red-600"></i>
                    Application Risk Heat Map
                </h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="risk-heatmap-chart"></canvas>
                </div>
            </div>

            <!-- Portfolio Health Over Time -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-heartbeat text-pink-600"></i>
                    Portfolio Health Trend (12 Months)
                </h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="health-trend-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 3: Strategic Quadrants -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Cost by Category -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-layer-group text-blue-600"></i>
                    Spend by Category
                </h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="cost-by-category-chart"></canvas>
                </div>
            </div>

            <!-- Health vs Value Matrix -->
            <div class="bg-white rounded-lg p-6 shadow-sm lg:col-span-2">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-scatter text-green-600"></i>
                    Strategic Positioning (211 Applications)
                </h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="health-value-matrix"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 4: Trend Analysis -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Age Distribution -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-clock text-orange-600"></i>
                    Application Age Distribution
                </h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="age-distribution-chart"></canvas>
                </div>
            </div>

            <!-- Vendor Concentration -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-building text-purple-600"></i>
                    Top Vendors by Cost
                </h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="vendor-concentration-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 5: Actionable Insights -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Redundancy Impact -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-copy text-red-600"></i>
                    Redundancy Cost Impact
                </h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="redundancy-chart"></canvas>
                </div>
            </div>

            <!-- Department Spend -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-users text-teal-600"></i>
                    Top Departments by Application Spend
                </h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="department-spend-chart"></canvas>
                </div>
            </div>
        </div>

    </div>
</div>

{% endblock %}

{% block extra_js %}
// Predictive Cost & Risk Modeling functionality
let costForecastChart = null;

// Add CSS for chart switch buttons
const style = document.createElement('style');
style.textContent = `
    .chart-switch-btn {
        background-color: transparent;
        color: #6B7280;
        border: none;
        cursor: pointer;
    }
    .chart-switch-btn:hover {
        background-color: #E5E7EB;
        color: #374151;
    }
    .chart-switch-btn.active {
        background-color: #10B981;
        color: white;
    }
`;
document.head.appendChild(style);

// Switchable BI Analytics Data
const switchableChartData = {
    cost: {
        labels: ['ERP Systems', 'CRM Platforms', 'Analytics Tools', 'Security Software', 'Collaboration', 'Infrastructure', 'Custom Apps', 'Other'],
        values: [5200000, 3800000, 2900000, 2100000, 1800000, 3200000, 2400000, 1200000],
        colors: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6', '#6B7280']
    },
    time: {
        labels: ['Tolerate', 'Invest', 'Migrate', 'Eliminate'],
        values: [72, 45, 42, 52],
        colors: ['#6B7280', '#10B981', '#3B82F6', '#EF4444']
    },
    risk: {
        // Generate realistic scatter data for 211 apps
        apps: Array.from({length: 211}, (_, i) => ({
            name: `App ${i + 1}`,
            risk: Math.random() * 100,
            value: Math.random() * 100,
            cost: 50000 + Math.random() * 500000
        }))
    },
    health: {
        months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        scores: [58, 57, 59, 58, 60, 61, 62, 63, 64, 63, 65, 66],
        incidents: [18, 16, 19, 15, 14, 12, 11, 10, 9, 8, 7, 6]
    },
    departments: {
        labels: ['IT Department', 'Finance', 'Police Department', 'Public Works', 'Human Resources', 'Fire Department', 'Planning & Dev', 'Parks & Rec', 'Water & Utilities', 'Legal'],
        values: [4200000, 3100000, 2800000, 2400000, 1900000, 1600000, 1400000, 1100000, 980000, 720000],
        apps: [35, 28, 24, 20, 18, 15, 12, 10, 8, 6]
    }
};

// Toggle Switchable Analytics section
document.getElementById('toggle-switchable-btn').addEventListener('click', function() {
    const collapsible = document.getElementById('switchable-collapsible');
    const icon = document.getElementById('switchable-toggle-icon');

    if (collapsible.style.display === 'none') {
        collapsible.style.display = 'block';
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');

        // Initialize charts when section opens
        setTimeout(() => {
            initializeSwitchableCharts();
        }, 100);
    } else {
        collapsible.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
});

let switchableChartsInitialized = false;

function initializeSwitchableCharts() {
    if (switchableChartsInitialized) return;
    switchableChartsInitialized = true;

    // Initialize all charts with default types
    switchCostChart('bar');
    switchTimeChart('pie');
    switchRiskChart('scatter');
    switchHealthChart('line');
    switchDeptChart('treemap');
    switchSavingsChart('waterfall');
    switchEvolutionChart('area');
    switchAgeCostChart('scatter');
    switchStrategicChart('radar');
    switchComplianceChart('heatmap');
}

// Additional data for new charts
const savingsData = {
    quarters: ['Q1 2025', 'Q2 2025', 'Q3 2025', 'Q4 2025', 'Q1 2026', 'Q2 2026'],
    planned: [0, 450000, 1200000, 2100000, 3200000, 4200000],
    actual: [0, 520000, 1350000, 2400000, 0, 0],
    categories: ['Retirements', 'Consolidation', 'Renegotiation', 'License Optimization', 'Cloud Migration'],
    categoryValues: [2100000, 1300000, 800000, 400000, 600000]
};

const evolutionData = {
    years: ['2021', '2022', '2023', '2024', '2025'],
    maintained: [180, 165, 150, 140, 130],
    modernized: [15, 25, 35, 45, 55],
    retired: [5, 20, 35, 52, 75],
    newApps: [10, 8, 12, 8, 6]
};

const ageCostData = {
    apps: Array.from({length: 100}, (_, i) => ({
        name: `App ${i + 1}`,
        age: Math.random() * 15,
        cost: 20000 + Math.random() * 480000,
        health: Math.floor(40 + Math.random() * 50)
    }))
};

const strategicData = {
    goals: ['Cost Reduction', 'Innovation', 'Customer Experience', 'Operational Efficiency', 'Risk Mitigation', 'Compliance'],
    current: [65, 45, 58, 72, 68, 82],
    target: [85, 70, 80, 85, 90, 95]
};

const complianceData = {
    frameworks: ['SOX', 'HIPAA', 'PCI-DSS', 'GDPR', 'ISO27001'],
    categories: ['ERP Systems', 'CRM Platforms', 'Analytics', 'Security', 'HR Systems', 'Finance Apps'],
    scores: [
        [92, 78, 85, 88, 90],
        [75, 82, 70, 85, 78],
        [68, 45, 55, 72, 65],
        [95, 88, 92, 90, 95],
        [82, 90, 65, 88, 85],
        [88, 75, 80, 82, 88]
    ]
};

// Helper to update button states
function updateButtonState(prefix, activeType) {
    document.querySelectorAll(`[id^="${prefix}-btn-"]`).forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`${prefix}-btn-${activeType}`).classList.add('active');
}

// COST BREAKDOWN CHART SWITCHING
function switchCostChart(type) {
    updateButtonState('cost', type);
    const data = switchableChartData.cost;

    let trace, layout;

    if (type === 'bar') {
        trace = [{
            x: data.labels,
            y: data.values,
            type: 'bar',
            marker: { color: data.colors },
            hovertemplate: '<b>%{x}</b><br>$%{y:,.0f}<extra></extra>'
        }];
        layout = {
            margin: { t: 20, b: 80, l: 80, r: 20 },
            yaxis: {
                title: 'Annual Cost ($)',
                tickformat: '$,.0f'
            },
            xaxis: { tickangle: -45 }
        };
    } else if (type === 'pie') {
        trace = [{
            labels: data.labels,
            values: data.values,
            type: 'pie',
            marker: { colors: data.colors },
            textinfo: 'label+percent',
            hovertemplate: '<b>%{label}</b><br>$%{value:,.0f}<br>%{percent}<extra></extra>'
        }];
        layout = {
            margin: { t: 20, b: 20, l: 20, r: 20 },
            showlegend: false
        };
    } else if (type === 'treemap') {
        trace = [{
            type: 'treemap',
            labels: data.labels,
            parents: data.labels.map(() => ''),
            values: data.values,
            marker: { colors: data.colors },
            textinfo: 'label+value',
            texttemplate: '<b>%{label}</b><br>$%{value:,.0f}',
            hovertemplate: '<b>%{label}</b><br>$%{value:,.0f}<extra></extra>'
        }];
        layout = {
            margin: { t: 10, b: 10, l: 10, r: 10 }
        };
    }

    Plotly.newPlot('switchable-cost-chart', trace, layout, {responsive: true, displayModeBar: false});
}

// TIME FRAMEWORK CHART SWITCHING
function switchTimeChart(type) {
    updateButtonState('time', type);
    const data = switchableChartData.time;

    let trace, layout;

    if (type === 'pie') {
        trace = [{
            labels: data.labels,
            values: data.values,
            type: 'pie',
            marker: { colors: data.colors },
            textinfo: 'label+value+percent',
            hovertemplate: '<b>%{label}</b><br>%{value} apps<br>%{percent}<extra></extra>'
        }];
        layout = {
            margin: { t: 20, b: 20, l: 20, r: 20 },
            showlegend: false
        };
    } else if (type === 'sunburst') {
        trace = [{
            type: 'sunburst',
            labels: ['Portfolio', ...data.labels],
            parents: ['', ...data.labels.map(() => 'Portfolio')],
            values: [data.values.reduce((a,b) => a+b, 0), ...data.values],
            marker: { colors: ['#E5E7EB', ...data.colors] },
            branchvalues: 'total',
            textinfo: 'label+value',
            hovertemplate: '<b>%{label}</b><br>%{value} apps<extra></extra>'
        }];
        layout = {
            margin: { t: 10, b: 10, l: 10, r: 10 }
        };
    } else if (type === 'donut') {
        trace = [{
            labels: data.labels,
            values: data.values,
            type: 'pie',
            hole: 0.5,
            marker: { colors: data.colors },
            textinfo: 'label+value',
            hovertemplate: '<b>%{label}</b><br>%{value} apps<br>%{percent}<extra></extra>'
        }];
        layout = {
            margin: { t: 20, b: 20, l: 20, r: 20 },
            showlegend: false,
            annotations: [{
                text: '211<br>Apps',
                showarrow: false,
                font: { size: 16, color: '#374151' }
            }]
        };
    }

    Plotly.newPlot('switchable-time-chart', trace, layout, {responsive: true, displayModeBar: false});
}

// RISK VS VALUE CHART SWITCHING
function switchRiskChart(type) {
    updateButtonState('risk', type);
    const apps = switchableChartData.risk.apps;

    let trace, layout;

    // Color based on quadrant
    const getColor = (risk, value) => {
        if (risk < 50 && value >= 50) return '#10B981'; // Low risk, high value - green
        if (risk >= 50 && value >= 50) return '#F59E0B'; // High risk, high value - orange (invest)
        if (risk < 50 && value < 50) return '#3B82F6'; // Low risk, low value - blue
        return '#EF4444'; // High risk, low value - red (retire)
    };

    if (type === 'scatter') {
        trace = [{
            x: apps.map(a => a.risk),
            y: apps.map(a => a.value),
            mode: 'markers',
            type: 'scatter',
            marker: {
                color: apps.map(a => getColor(a.risk, a.value)),
                size: 8,
                opacity: 0.7
            },
            text: apps.map(a => a.name),
            hovertemplate: '<b>%{text}</b><br>Risk: %{x:.0f}<br>Value: %{y:.0f}<extra></extra>'
        }];
        layout = {
            margin: { t: 20, b: 50, l: 50, r: 20 },
            xaxis: { title: 'Risk Score (0-100)', range: [0, 100] },
            yaxis: { title: 'Business Value (0-100)', range: [0, 100] },
            shapes: [
                // Quadrant lines
                { type: 'line', x0: 50, x1: 50, y0: 0, y1: 100, line: { color: '#E5E7EB', width: 2, dash: 'dash' } },
                { type: 'line', x0: 0, x1: 100, y0: 50, y1: 50, line: { color: '#E5E7EB', width: 2, dash: 'dash' } }
            ]
        };
    } else if (type === 'bubble') {
        trace = [{
            x: apps.map(a => a.risk),
            y: apps.map(a => a.value),
            mode: 'markers',
            type: 'scatter',
            marker: {
                color: apps.map(a => getColor(a.risk, a.value)),
                size: apps.map(a => Math.sqrt(a.cost) / 50),
                sizemode: 'diameter',
                opacity: 0.6
            },
            text: apps.map(a => `${a.name}<br>Cost: $${a.cost.toLocaleString()}`),
            hovertemplate: '<b>%{text}</b><br>Risk: %{x:.0f}<br>Value: %{y:.0f}<extra></extra>'
        }];
        layout = {
            margin: { t: 20, b: 50, l: 50, r: 20 },
            xaxis: { title: 'Risk Score', range: [0, 100] },
            yaxis: { title: 'Business Value', range: [0, 100] },
            shapes: [
                { type: 'line', x0: 50, x1: 50, y0: 0, y1: 100, line: { color: '#E5E7EB', width: 2, dash: 'dash' } },
                { type: 'line', x0: 0, x1: 100, y0: 50, y1: 50, line: { color: '#E5E7EB', width: 2, dash: 'dash' } }
            ]
        };
    } else if (type === 'heatmap') {
        // Create 10x10 grid for heatmap
        const gridSize = 10;
        const z = Array(gridSize).fill(0).map(() => Array(gridSize).fill(0));
        apps.forEach(app => {
            const xi = Math.min(Math.floor(app.risk / 10), 9);
            const yi = Math.min(Math.floor(app.value / 10), 9);
            z[yi][xi]++;
        });

        trace = [{
            z: z,
            type: 'heatmap',
            colorscale: [[0, '#F0FDF4'], [0.5, '#86EFAC'], [1, '#16A34A']],
            hovertemplate: 'Risk: %{x}0-%{x}9<br>Value: %{y}0-%{y}9<br>Apps: %{z}<extra></extra>'
        }];
        layout = {
            margin: { t: 20, b: 50, l: 50, r: 20 },
            xaxis: { title: 'Risk Score (0-100)', tickvals: [0,2,4,6,8], ticktext: ['0-20','20-40','40-60','60-80','80-100'] },
            yaxis: { title: 'Business Value', tickvals: [0,2,4,6,8], ticktext: ['0-20','20-40','40-60','60-80','80-100'] }
        };
    }

    Plotly.newPlot('switchable-risk-chart', trace, layout, {responsive: true, displayModeBar: false});
}

// HEALTH TRENDS CHART SWITCHING
function switchHealthChart(type) {
    updateButtonState('health', type);
    const data = switchableChartData.health;

    let traces, layout;

    if (type === 'line') {
        traces = [
            {
                x: data.months,
                y: data.scores,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Health Score',
                line: { color: '#3B82F6', width: 3 },
                marker: { size: 8 },
                yaxis: 'y'
            },
            {
                x: data.months,
                y: data.incidents,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Incidents',
                line: { color: '#EF4444', width: 3 },
                marker: { size: 8 },
                yaxis: 'y2'
            }
        ];
        layout = {
            margin: { t: 20, b: 40, l: 50, r: 50 },
            yaxis: { title: 'Health Score', range: [0, 100], side: 'left' },
            yaxis2: { title: 'Incidents', range: [0, 25], overlaying: 'y', side: 'right' },
            legend: { x: 0.5, y: 1.1, xanchor: 'center', orientation: 'h' }
        };
    } else if (type === 'area') {
        traces = [
            {
                x: data.months,
                y: data.scores,
                type: 'scatter',
                mode: 'lines',
                fill: 'tozeroy',
                name: 'Health Score',
                line: { color: '#3B82F6' },
                fillcolor: 'rgba(59, 130, 246, 0.3)'
            }
        ];
        layout = {
            margin: { t: 20, b: 40, l: 50, r: 20 },
            yaxis: { title: 'Health Score', range: [0, 100] },
            showlegend: false
        };
    } else if (type === 'bar') {
        traces = [
            {
                x: data.months,
                y: data.scores,
                type: 'bar',
                name: 'Health Score',
                marker: { color: '#3B82F6' }
            },
            {
                x: data.months,
                y: data.incidents.map(i => i * 5), // Scale to show on same axis
                type: 'bar',
                name: 'Incidents (x5)',
                marker: { color: '#EF4444' }
            }
        ];
        layout = {
            margin: { t: 20, b: 40, l: 50, r: 20 },
            yaxis: { title: 'Score / Incidents' },
            barmode: 'group',
            legend: { x: 0.5, y: 1.1, xanchor: 'center', orientation: 'h' }
        };
    }

    Plotly.newPlot('switchable-health-chart', traces, layout, {responsive: true, displayModeBar: false});
}

// DEPARTMENT BREAKDOWN CHART SWITCHING
function switchDeptChart(type) {
    updateButtonState('dept', type);
    const data = switchableChartData.departments;

    const colors = ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316', '#6366F1', '#84CC16'];

    let trace, layout;

    if (type === 'treemap') {
        trace = [{
            type: 'treemap',
            labels: data.labels,
            parents: data.labels.map(() => ''),
            values: data.values,
            marker: { colors: colors },
            textinfo: 'label+value',
            texttemplate: '<b>%{label}</b><br>$%{value:,.0f}',
            hovertemplate: '<b>%{label}</b><br>$%{value:,.0f}<extra></extra>'
        }];
        layout = {
            margin: { t: 10, b: 10, l: 10, r: 10 }
        };
    } else if (type === 'sunburst') {
        trace = [{
            type: 'sunburst',
            labels: ['All Departments', ...data.labels],
            parents: ['', ...data.labels.map(() => 'All Departments')],
            values: [data.values.reduce((a,b) => a+b, 0), ...data.values],
            marker: { colors: ['#E5E7EB', ...colors] },
            branchvalues: 'total',
            textinfo: 'label',
            hovertemplate: '<b>%{label}</b><br>$%{value:,.0f}<extra></extra>'
        }];
        layout = {
            margin: { t: 10, b: 10, l: 10, r: 10 }
        };
    } else if (type === 'bar') {
        trace = [{
            y: data.labels,
            x: data.values,
            type: 'bar',
            orientation: 'h',
            marker: { color: colors },
            text: data.values.map(v => '$' + (v/1000000).toFixed(1) + 'M'),
            textposition: 'outside',
            hovertemplate: '<b>%{y}</b><br>$%{x:,.0f}<extra></extra>'
        }];
        layout = {
            margin: { t: 20, b: 50, l: 120, r: 60 },
            xaxis: {
                title: 'Annual Spend ($)',
                tickformat: '$,.0f'
            }
        };
    }

    Plotly.newPlot('switchable-dept-chart', trace, layout, {responsive: true, displayModeBar: false});
}

// COST SAVINGS REALIZATION CHART SWITCHING
function switchSavingsChart(type) {
    updateButtonState('savings', type);

    let traces, layout;

    if (type === 'waterfall') {
        traces = [{
            type: 'waterfall',
            orientation: 'v',
            x: ['Current Cost', ...savingsData.categories, 'Target Cost'],
            y: [22600000, -2100000, -1300000, -800000, -400000, -600000, 17400000],
            connector: { line: { color: '#E5E7EB' } },
            decreasing: { marker: { color: '#10B981' } },
            increasing: { marker: { color: '#EF4444' } },
            totals: { marker: { color: '#3B82F6' } },
            textposition: 'outside',
            text: ['$22.6M', '-$2.1M', '-$1.3M', '-$0.8M', '-$0.4M', '-$0.6M', '$17.4M'],
            hovertemplate: '<b>%{x}</b><br>%{text}<extra></extra>'
        }];
        layout = {
            margin: { t: 30, b: 80, l: 80, r: 20 },
            yaxis: { title: 'Annual Cost ($)', tickformat: '$,.0f' },
            xaxis: { tickangle: -30 },
            showlegend: false
        };
    } else if (type === 'line') {
        traces = [
            {
                x: savingsData.quarters,
                y: savingsData.planned,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Planned Savings',
                line: { color: '#3B82F6', width: 3, dash: 'dash' },
                marker: { size: 8 }
            },
            {
                x: savingsData.quarters,
                y: savingsData.actual,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Actual Savings',
                line: { color: '#10B981', width: 3 },
                marker: { size: 10 },
                fill: 'tozeroy',
                fillcolor: 'rgba(16, 185, 129, 0.2)'
            }
        ];
        layout = {
            margin: { t: 30, b: 40, l: 80, r: 20 },
            yaxis: { title: 'Cumulative Savings ($)', tickformat: '$,.0f' },
            legend: { x: 0.5, y: 1.15, xanchor: 'center', orientation: 'h' }
        };
    } else if (type === 'gauge') {
        const totalPlanned = 5200000;
        const totalActual = 4270000;
        const percentage = (totalActual / totalPlanned) * 100;

        traces = [{
            type: 'indicator',
            mode: 'gauge+number+delta',
            value: totalActual,
            number: { prefix: '$', valueformat: ',.0f' },
            delta: { reference: totalPlanned, valueformat: ',.0f', prefix: '$' },
            gauge: {
                axis: { range: [0, 6000000], tickformat: '$,.0f' },
                bar: { color: '#10B981' },
                steps: [
                    { range: [0, 3000000], color: '#FEF3C7' },
                    { range: [3000000, 5000000], color: '#D1FAE5' },
                    { range: [5000000, 6000000], color: '#A7F3D0' }
                ],
                threshold: {
                    line: { color: '#3B82F6', width: 4 },
                    thickness: 0.75,
                    value: totalPlanned
                }
            },
            title: { text: 'Savings Achievement', font: { size: 16 } }
        }];
        layout = {
            margin: { t: 60, b: 20, l: 30, r: 30 }
        };
    }

    Plotly.newPlot('switchable-savings-chart', traces, layout, {responsive: true, displayModeBar: false});
}

// PORTFOLIO EVOLUTION CHART SWITCHING
function switchEvolutionChart(type) {
    updateButtonState('evolution', type);

    let traces, layout;

    if (type === 'area') {
        traces = [
            {
                x: evolutionData.years,
                y: evolutionData.maintained,
                type: 'scatter',
                mode: 'lines',
                name: 'Maintained',
                fill: 'tonexty',
                stackgroup: 'one',
                line: { color: '#6B7280' }
            },
            {
                x: evolutionData.years,
                y: evolutionData.modernized,
                type: 'scatter',
                mode: 'lines',
                name: 'Modernized',
                fill: 'tonexty',
                stackgroup: 'one',
                line: { color: '#3B82F6' }
            },
            {
                x: evolutionData.years,
                y: evolutionData.retired,
                type: 'scatter',
                mode: 'lines',
                name: 'Retired',
                fill: 'tonexty',
                stackgroup: 'one',
                line: { color: '#EF4444' }
            }
        ];
        layout = {
            margin: { t: 30, b: 40, l: 50, r: 20 },
            yaxis: { title: 'Applications' },
            legend: { x: 0.5, y: 1.15, xanchor: 'center', orientation: 'h' }
        };
    } else if (type === 'bar') {
        traces = [
            { x: evolutionData.years, y: evolutionData.maintained, type: 'bar', name: 'Maintained', marker: { color: '#6B7280' } },
            { x: evolutionData.years, y: evolutionData.modernized, type: 'bar', name: 'Modernized', marker: { color: '#3B82F6' } },
            { x: evolutionData.years, y: evolutionData.retired, type: 'bar', name: 'Retired', marker: { color: '#EF4444' } }
        ];
        layout = {
            margin: { t: 30, b: 40, l: 50, r: 20 },
            barmode: 'stack',
            yaxis: { title: 'Applications' },
            legend: { x: 0.5, y: 1.15, xanchor: 'center', orientation: 'h' }
        };
    } else if (type === 'line') {
        traces = [
            { x: evolutionData.years, y: evolutionData.maintained, type: 'scatter', mode: 'lines+markers', name: 'Maintained', line: { color: '#6B7280', width: 3 } },
            { x: evolutionData.years, y: evolutionData.modernized, type: 'scatter', mode: 'lines+markers', name: 'Modernized', line: { color: '#3B82F6', width: 3 } },
            { x: evolutionData.years, y: evolutionData.retired, type: 'scatter', mode: 'lines+markers', name: 'Retired', line: { color: '#EF4444', width: 3 } }
        ];
        layout = {
            margin: { t: 30, b: 40, l: 50, r: 20 },
            yaxis: { title: 'Applications' },
            legend: { x: 0.5, y: 1.15, xanchor: 'center', orientation: 'h' }
        };
    }

    Plotly.newPlot('switchable-evolution-chart', traces, layout, {responsive: true, displayModeBar: false});
}

// AGE VS COST CHART SWITCHING
function switchAgeCostChart(type) {
    updateButtonState('agecost', type);
    const apps = ageCostData.apps;

    let traces, layout;

    const getHealthColor = (health) => {
        if (health >= 70) return '#10B981';
        if (health >= 55) return '#F59E0B';
        return '#EF4444';
    };

    if (type === 'scatter') {
        traces = [{
            x: apps.map(a => a.age),
            y: apps.map(a => a.cost),
            mode: 'markers',
            type: 'scatter',
            marker: {
                color: apps.map(a => getHealthColor(a.health)),
                size: 10,
                opacity: 0.7
            },
            text: apps.map(a => `${a.name}<br>Health: ${a.health}`),
            hovertemplate: '<b>%{text}</b><br>Age: %{x:.1f} years<br>Cost: $%{y:,.0f}<extra></extra>'
        }];
        layout = {
            margin: { t: 20, b: 50, l: 80, r: 20 },
            xaxis: { title: 'Application Age (Years)' },
            yaxis: { title: 'Annual Cost ($)', tickformat: '$,.0f' },
            shapes: [
                { type: 'line', x0: 7, x1: 7, y0: 0, y1: 500000, line: { color: '#EF4444', width: 2, dash: 'dash' } }
            ],
            annotations: [
                { x: 7, y: 480000, text: 'Legacy Threshold', showarrow: false, font: { color: '#EF4444', size: 10 } }
            ]
        };
    } else if (type === 'bubble') {
        traces = [{
            x: apps.map(a => a.age),
            y: apps.map(a => a.cost),
            mode: 'markers',
            type: 'scatter',
            marker: {
                color: apps.map(a => getHealthColor(a.health)),
                size: apps.map(a => a.health / 5),
                sizemode: 'diameter',
                opacity: 0.6
            },
            text: apps.map(a => `${a.name}<br>Health: ${a.health}`),
            hovertemplate: '<b>%{text}</b><br>Age: %{x:.1f} years<br>Cost: $%{y:,.0f}<extra></extra>'
        }];
        layout = {
            margin: { t: 20, b: 50, l: 80, r: 20 },
            xaxis: { title: 'Application Age (Years)' },
            yaxis: { title: 'Annual Cost ($)', tickformat: '$,.0f' }
        };
    } else if (type === 'bar') {
        // Group by age buckets
        const buckets = ['0-2 years', '2-5 years', '5-7 years', '7-10 years', '10+ years'];
        const bucketCosts = [0, 0, 0, 0, 0];
        const bucketCounts = [0, 0, 0, 0, 0];

        apps.forEach(a => {
            let idx = a.age < 2 ? 0 : a.age < 5 ? 1 : a.age < 7 ? 2 : a.age < 10 ? 3 : 4;
            bucketCosts[idx] += a.cost;
            bucketCounts[idx]++;
        });

        traces = [{
            x: buckets,
            y: bucketCosts,
            type: 'bar',
            marker: { color: ['#10B981', '#3B82F6', '#F59E0B', '#F97316', '#EF4444'] },
            text: bucketCounts.map(c => `${c} apps`),
            textposition: 'auto',
            hovertemplate: '<b>%{x}</b><br>Total Cost: $%{y:,.0f}<br>%{text}<extra></extra>'
        }];
        layout = {
            margin: { t: 20, b: 40, l: 80, r: 20 },
            yaxis: { title: 'Total Cost ($)', tickformat: '$,.0f' }
        };
    }

    Plotly.newPlot('switchable-agecost-chart', traces, layout, {responsive: true, displayModeBar: false});
}

// STRATEGIC ALIGNMENT CHART SWITCHING
function switchStrategicChart(type) {
    updateButtonState('strategic', type);

    let traces, layout;

    if (type === 'radar') {
        traces = [
            {
                type: 'scatterpolar',
                r: [...strategicData.current, strategicData.current[0]],
                theta: [...strategicData.goals, strategicData.goals[0]],
                fill: 'toself',
                name: 'Current',
                fillcolor: 'rgba(59, 130, 246, 0.3)',
                line: { color: '#3B82F6', width: 2 }
            },
            {
                type: 'scatterpolar',
                r: [...strategicData.target, strategicData.target[0]],
                theta: [...strategicData.goals, strategicData.goals[0]],
                fill: 'toself',
                name: 'Target',
                fillcolor: 'rgba(16, 185, 129, 0.2)',
                line: { color: '#10B981', width: 2, dash: 'dash' }
            }
        ];
        layout = {
            polar: {
                radialaxis: { visible: true, range: [0, 100] }
            },
            margin: { t: 40, b: 40, l: 60, r: 60 },
            legend: { x: 0.5, y: -0.1, xanchor: 'center', orientation: 'h' }
        };
    } else if (type === 'bar') {
        traces = [
            {
                x: strategicData.goals,
                y: strategicData.current,
                type: 'bar',
                name: 'Current',
                marker: { color: '#3B82F6' }
            },
            {
                x: strategicData.goals,
                y: strategicData.target,
                type: 'bar',
                name: 'Target',
                marker: { color: '#10B981' }
            }
        ];
        layout = {
            margin: { t: 30, b: 80, l: 50, r: 20 },
            barmode: 'group',
            yaxis: { title: 'Alignment Score', range: [0, 100] },
            xaxis: { tickangle: -30 },
            legend: { x: 0.5, y: 1.1, xanchor: 'center', orientation: 'h' }
        };
    } else if (type === 'heatmap') {
        // Gap analysis heatmap
        const gaps = strategicData.goals.map((_, i) => strategicData.target[i] - strategicData.current[i]);

        traces = [{
            z: [gaps],
            x: strategicData.goals,
            y: ['Gap to Target'],
            type: 'heatmap',
            colorscale: [[0, '#10B981'], [0.5, '#FEF3C7'], [1, '#EF4444']],
            text: [gaps.map(g => `${g} points`)],
            texttemplate: '%{text}',
            hovertemplate: '<b>%{x}</b><br>Gap: %{z} points<extra></extra>'
        }];
        layout = {
            margin: { t: 20, b: 80, l: 30, r: 30 },
            xaxis: { tickangle: -30 }
        };
    }

    Plotly.newPlot('switchable-strategic-chart', traces, layout, {responsive: true, displayModeBar: false});
}

// COMPLIANCE HEATMAP CHART SWITCHING
function switchComplianceChart(type) {
    updateButtonState('compliance', type);

    let traces, layout;

    if (type === 'heatmap') {
        traces = [{
            z: complianceData.scores,
            x: complianceData.frameworks,
            y: complianceData.categories,
            type: 'heatmap',
            colorscale: [[0, '#FEE2E2'], [0.5, '#FEF3C7'], [1, '#D1FAE5']],
            text: complianceData.scores.map(row => row.map(s => `${s}%`)),
            texttemplate: '%{text}',
            hovertemplate: '<b>%{y}</b><br>%{x}: %{z}%<extra></extra>'
        }];
        layout = {
            margin: { t: 20, b: 60, l: 120, r: 20 },
            xaxis: { side: 'bottom' }
        };
    } else if (type === 'bar') {
        // Average compliance by framework
        const avgByFramework = complianceData.frameworks.map((_, fi) => {
            const sum = complianceData.scores.reduce((acc, row) => acc + row[fi], 0);
            return sum / complianceData.scores.length;
        });

        const colors = avgByFramework.map(v => v >= 80 ? '#10B981' : v >= 60 ? '#F59E0B' : '#EF4444');

        traces = [{
            x: complianceData.frameworks,
            y: avgByFramework,
            type: 'bar',
            marker: { color: colors },
            text: avgByFramework.map(v => `${v.toFixed(0)}%`),
            textposition: 'outside',
            hovertemplate: '<b>%{x}</b><br>Avg Compliance: %{y:.1f}%<extra></extra>'
        }];
        layout = {
            margin: { t: 30, b: 40, l: 50, r: 20 },
            yaxis: { title: 'Average Compliance %', range: [0, 100] }
        };
    } else if (type === 'radar') {
        // Compliance by category as radar
        const categoryAvgs = complianceData.categories.map((_, ci) => {
            const sum = complianceData.scores[ci].reduce((a, b) => a + b, 0);
            return sum / complianceData.scores[ci].length;
        });

        traces = [{
            type: 'scatterpolar',
            r: [...categoryAvgs, categoryAvgs[0]],
            theta: [...complianceData.categories, complianceData.categories[0]],
            fill: 'toself',
            name: 'Avg Compliance',
            fillcolor: 'rgba(59, 130, 246, 0.3)',
            line: { color: '#3B82F6', width: 2 }
        }];
        layout = {
            polar: {
                radialaxis: { visible: true, range: [0, 100] }
            },
            margin: { t: 40, b: 40, l: 80, r: 80 },
            showlegend: false
        };
    }

    Plotly.newPlot('switchable-compliance-chart', traces, layout, {responsive: true, displayModeBar: false});
}

// Department Executive Scorecards
const departmentData = {
    departments: [
        { name: 'IT Department', apps: 35, cost: 4200000, health: 68, retire: 8, invest: 12, migrate: 10, maintain: 5 },
        { name: 'Finance', apps: 28, cost: 3100000, health: 72, retire: 5, invest: 10, migrate: 8, maintain: 5 },
        { name: 'Police Department', apps: 24, cost: 2800000, health: 58, retire: 9, invest: 6, migrate: 6, maintain: 3 },
        { name: 'Public Works', apps: 20, cost: 2400000, health: 61, retire: 7, invest: 5, migrate: 5, maintain: 3 },
        { name: 'Human Resources', apps: 18, cost: 1900000, health: 75, retire: 3, invest: 8, migrate: 4, maintain: 3 },
        { name: 'Fire Department', apps: 15, cost: 1600000, health: 55, retire: 6, invest: 4, migrate: 3, maintain: 2 },
        { name: 'Planning & Dev', apps: 12, cost: 1400000, health: 70, retire: 2, invest: 5, migrate: 3, maintain: 2 },
        { name: 'Parks & Recreation', apps: 10, cost: 1100000, health: 64, retire: 3, invest: 3, migrate: 2, maintain: 2 },
        { name: 'Water & Utilities', apps: 8, cost: 980000, health: 59, retire: 3, invest: 2, migrate: 2, maintain: 1 },
        { name: 'Legal Department', apps: 6, cost: 720000, health: 77, retire: 1, invest: 3, migrate: 1, maintain: 1 }
    ]
};

// Toggle Department Scorecards section
document.getElementById('toggle-dept-scorecards-btn').addEventListener('click', function() {
    const collapsible = document.getElementById('dept-scorecards-collapsible');
    const icon = document.getElementById('dept-scorecards-toggle-icon');

    if (collapsible.style.display === 'none') {
        collapsible.style.display = 'block';
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');

        // Initialize scorecards when section opens
        setTimeout(() => {
            renderDepartmentScorecards();
            renderDeptComparisonCharts();
        }, 100);
    } else {
        collapsible.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
});

function renderDepartmentScorecards() {
    const container = document.getElementById('department-scorecards-container');
    if (!container) return;

    const getHealthColor = (health) => {
        if (health >= 70) return { bg: 'from-green-500 to-green-600', text: 'text-green-600', badge: 'bg-green-100' };
        if (health >= 60) return { bg: 'from-yellow-500 to-yellow-600', text: 'text-yellow-600', badge: 'bg-yellow-100' };
        return { bg: 'from-red-500 to-red-600', text: 'text-red-600', badge: 'bg-red-100' };
    };

    let html = '';
    departmentData.departments.forEach(dept => {
        const colors = getHealthColor(dept.health);
        const savingsEstimate = dept.retire * 85000; // Rough estimate per retired app

        html += `
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="bg-gradient-to-r ${colors.bg} p-4 text-white">
                <h4 class="font-bold text-lg">${dept.name}</h4>
                <p class="text-sm opacity-90">${dept.apps} Applications</p>
            </div>
            <div class="p-4 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Annual Cost</span>
                    <span class="font-bold text-gray-800">$${(dept.cost / 1000000).toFixed(1)}M</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Health Score</span>
                    <span class="font-bold ${colors.text}">${dept.health}/100</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Potential Savings</span>
                    <span class="font-bold text-green-600">$${(savingsEstimate / 1000).toFixed(0)}K</span>
                </div>
                <div class="pt-2 border-t">
                    <div class="flex justify-between text-xs">
                        <span class="px-2 py-1 bg-red-100 text-red-700 rounded">Retire: ${dept.retire}</span>
                        <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded">Invest: ${dept.invest}</span>
                        <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded">Migrate: ${dept.migrate}</span>
                    </div>
                </div>
            </div>
        </div>
        `;
    });

    container.innerHTML = html;
}

function renderDeptComparisonCharts() {
    const depts = departmentData.departments;
    const colors = ['#06B6D4', '#0EA5E9', '#3B82F6', '#6366F1', '#8B5CF6', '#A855F7', '#D946EF', '#EC4899', '#F43F5E', '#F97316'];

    // Cost comparison chart
    const costTrace = [{
        y: depts.map(d => d.name),
        x: depts.map(d => d.cost),
        type: 'bar',
        orientation: 'h',
        marker: { color: colors },
        text: depts.map(d => '$' + (d.cost / 1000000).toFixed(1) + 'M'),
        textposition: 'outside',
        hovertemplate: '<b>%{y}</b><br>$%{x:,.0f}<extra></extra>'
    }];

    const costLayout = {
        margin: { t: 10, b: 40, l: 120, r: 60 },
        xaxis: { title: 'Annual Cost ($)', tickformat: '$,.0f' },
        yaxis: { automargin: true }
    };

    Plotly.newPlot('dept-cost-comparison-chart', costTrace, costLayout, {responsive: true, displayModeBar: false});

    // Health comparison chart
    const healthColors = depts.map(d => {
        if (d.health >= 70) return '#10B981';
        if (d.health >= 60) return '#F59E0B';
        return '#EF4444';
    });

    const healthTrace = [{
        y: depts.map(d => d.name),
        x: depts.map(d => d.health),
        type: 'bar',
        orientation: 'h',
        marker: { color: healthColors },
        text: depts.map(d => d.health + '/100'),
        textposition: 'outside',
        hovertemplate: '<b>%{y}</b><br>Health: %{x}/100<extra></extra>'
    }];

    const healthLayout = {
        margin: { t: 10, b: 40, l: 120, r: 40 },
        xaxis: { title: 'Health Score', range: [0, 100] },
        yaxis: { automargin: true }
    };

    Plotly.newPlot('dept-health-comparison-chart', healthTrace, healthLayout, {responsive: true, displayModeBar: false});
}

// Toggle predictions section
document.getElementById('toggle-predictions-btn').addEventListener('click', function() {
    const collapsible = document.getElementById('predictions-collapsible');
    const icon = document.getElementById('predictions-toggle-icon');

    if (collapsible.style.display === 'none') {
        collapsible.style.display = 'block';
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');

        // Resize chart after opening to prevent growing
        if (costForecastChart) {
            setTimeout(() => {
                costForecastChart.resize();
            }, 100);
        }
    } else {
        collapsible.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
});

async function loadPredictions() {
    const loadingDiv = document.getElementById('predictions-loading');
    const contentDiv = document.getElementById('predictions-content');
    const errorDiv = document.getElementById('predictions-error');
    const refreshBtn = document.getElementById('refresh-predictions-btn');

    // Reset state
    contentDiv.classList.add('hidden');
    errorDiv.classList.add('hidden');
    loadingDiv.classList.remove('hidden');
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

    try {
        const response = await fetch('/api/predictions');
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to generate predictions');
        }

        // 1. Render Cost Forecast Chart
        const costForecast = data.cost_forecast || [];
        if (costForecast.length > 0) {
            const ctx = document.getElementById('cost-forecast-chart').getContext('2d');

            // Destroy existing chart if it exists
            if (costForecastChart) {
                costForecastChart.destroy();
            }

            const currentYear = new Date().getFullYear();
            const labels = ['Current', ...costForecast.map(f => `Year ${f.year}`)];
            const currentCost = costForecast.length > 0 ? costForecast[0].projected_cost / (1 + costForecast[0].growth_rate) : 0;
            const costs = [currentCost, ...costForecast.map(f => f.projected_cost)];

            costForecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Projected Portfolio Cost',
                        data: costs,
                        borderColor: '#9333EA',
                        backgroundColor: 'rgba(147, 51, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#9333EA',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Cost: $' + context.parsed.y.toLocaleString('en-US', {maximumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 2. Render ROI Analysis
        const roiAnalysis = data.roi_analysis || {};
        const roiDiv = document.getElementById('roi-analysis');
        roiDiv.innerHTML = '';

        if (roiAnalysis.retire_count > 0) {
            const roiHtml = `
                <div class="space-y-3">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <p class="text-xs text-gray-600 mb-1">Apps to Retire</p>
                        <p class="text-2xl font-bold text-blue-700">${roiAnalysis.retire_count}</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                        <p class="text-xs text-gray-600 mb-1">Annual Savings</p>
                        <p class="text-2xl font-bold text-green-700">$${(roiAnalysis.annual_savings / 1000000).toFixed(2)}M</p>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                        <p class="text-xs text-gray-600 mb-1">Migration Cost</p>
                        <p class="text-2xl font-bold text-yellow-700">$${(roiAnalysis.migration_cost / 1000000).toFixed(2)}M</p>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                        <p class="text-xs text-gray-600 mb-1">Payback Period</p>
                        <p class="text-2xl font-bold text-purple-700">${roiAnalysis.payback_months.toFixed(1)} mo</p>
                    </div>
                    <div class="${roiAnalysis.three_year_roi > 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} p-3 rounded-lg border">
                        <p class="text-xs text-gray-600 mb-1">3-Year ROI</p>
                        <p class="text-2xl font-bold ${roiAnalysis.three_year_roi > 0 ? 'text-green-700' : 'text-red-700'}">
                            ${roiAnalysis.three_year_roi > 0 ? '+' : ''}$${(roiAnalysis.three_year_roi / 1000000).toFixed(2)}M
                        </p>
                    </div>
                </div>
            `;
            roiDiv.innerHTML = roiHtml;
        } else {
            roiDiv.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-info-circle text-4xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 text-sm">No retirement candidates identified</p>
                </div>
            `;
        }

        // 3. Render High-Risk Apps Table (limit to top 5)
        const highRiskApps = (data.high_risk_apps || []).slice(0, 5);
        const tbody = document.getElementById('high-risk-tbody');
        tbody.innerHTML = '';

        if (highRiskApps.length > 0) {
            highRiskApps.forEach(app => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                // Risk score color coding
                let riskClass = 'bg-yellow-100 text-yellow-800';
                if (app.risk_score > 50) {
                    riskClass = 'bg-red-100 text-red-800';
                } else if (app.risk_score > 30) {
                    riskClass = 'bg-orange-100 text-orange-800';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${app.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span class="px-2 py-1 text-xs font-semibold bg-gray-100 rounded">${app.technical_health.toFixed(1)}/10</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">$${app.annual_cost.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-3 py-1 rounded-full font-semibold ${riskClass}">${app.risk_score.toFixed(1)}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                        <i class="fas fa-check-circle text-4xl text-green-500 mb-2"></i>
                        <p>No high-risk applications identified</p>
                    </td>
                </tr>
            `;
        }

        // Show content
        loadingDiv.classList.add('hidden');
        contentDiv.classList.remove('hidden');

    } catch (error) {
        console.error('Error loading predictions:', error);
        loadingDiv.classList.add('hidden');
        errorDiv.classList.remove('hidden');
        document.getElementById('predictions-error-message').textContent = error.message;
    } finally {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Predictions';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refresh-predictions-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadPredictions);
        // Auto-load predictions on page load
        loadPredictions();
    }
});

// AI Executive Summary functionality
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-summary-btn');
    const loadingDiv = document.getElementById('summary-loading');
    const contentDiv = document.getElementById('summary-content');
    const errorDiv = document.getElementById('summary-error');

    if (generateBtn) {
        generateBtn.addEventListener('click', async function() {
            // Reset state
            contentDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

            try {
                const response = await fetch('/api/ai/summary');
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to generate summary');
                }

                // Display overview
                document.querySelector('#summary-overview p').textContent = data.overview;

                // Display narrative
                document.getElementById('summary-narrative').textContent = data.narrative;

                // Display insights with color coding
                const insightsDiv = document.getElementById('summary-insights');
                insightsDiv.innerHTML = '';

                if (data.insights && data.insights.length > 0) {
                    // Show max 5 insights
                    data.insights.slice(0, 5).forEach(insight => {
                        const insightEl = document.createElement('div');

                        let icon = 'ðŸ”µ';
                        let colorClass = 'border-blue-500 bg-blue-50';

                        if (insight.type === 'critical') {
                            icon = 'ðŸ”´';
                            colorClass = 'border-red-500 bg-red-50';
                        } else if (insight.type === 'warning') {
                            icon = 'ðŸŸ¡';
                            colorClass = 'border-yellow-500 bg-yellow-50';
                        } else if (insight.type === 'opportunity') {
                            icon = 'ðŸŸ¢';
                            colorClass = 'border-green-500 bg-green-50';
                        }

                        insightEl.className = `p-3 rounded-lg border-l-4 ${colorClass}`;
                        insightEl.innerHTML = `
                            <div class="flex items-start gap-2">
                                <span class="text-lg">${icon}</span>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-800">${insight.category || 'Insight'}</p>
                                    <p class="text-sm text-gray-700 mt-1">${insight.message}</p>
                                </div>
                            </div>
                        `;
                        insightsDiv.appendChild(insightEl);
                    });
                } else {
                    insightsDiv.innerHTML = '<p class="text-gray-500 text-sm">No significant insights identified.</p>';
                }

                // Display recommendations
                const recsDiv = document.getElementById('summary-recommendations');
                recsDiv.innerHTML = '';

                if (data.recommendations && data.recommendations.length > 0) {
                    // Show top 3 recommendations
                    data.recommendations.slice(0, 3).forEach((rec, index) => {
                        const recEl = document.createElement('div');

                        let priorityBadge = '';
                        if (rec.priority === 'high') {
                            priorityBadge = '<span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded">HIGH</span>';
                        } else if (rec.priority === 'medium') {
                            priorityBadge = '<span class="px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded">MEDIUM</span>';
                        } else {
                            priorityBadge = '<span class="px-2 py-1 text-xs font-semibold bg-blue-100 text-blue-800 rounded">LOW</span>';
                        }

                        recEl.className = 'p-4 rounded-lg border border-gray-200 bg-gray-50';
                        recEl.innerHTML = `
                            <div class="flex items-start justify-between gap-2 mb-2">
                                <span class="font-semibold text-gray-800">${index + 1}.</span>
                                ${priorityBadge}
                            </div>
                            <p class="text-sm text-gray-800 font-medium mb-2">${rec.action}</p>
                            <div class="flex items-center gap-4 text-xs text-gray-600">
                                <span><i class="far fa-clock mr-1"></i>${rec.timeline}</span>
                                <span><i class="fas fa-bullseye mr-1"></i>${rec.category || 'General'}</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-2 italic">${rec.impact}</p>
                        `;
                        recsDiv.appendChild(recEl);
                    });
                } else {
                    recsDiv.innerHTML = '<p class="text-gray-500 text-sm">No recommendations available.</p>';
                }

                // Show content
                loadingDiv.classList.add('hidden');
                contentDiv.classList.remove('hidden');

            } catch (error) {
                console.error('Error generating AI summary:', error);
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
                document.getElementById('summary-error-message').textContent = error.message;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Regenerate Summary';
            }
        });
    }
});

// Render Plotly charts
document.addEventListener('DOMContentLoaded', function() {
    // Score Distribution Chart
    if (document.getElementById('score-distribution')) {
        Plotly.newPlot('score-distribution', {{ charts.score_distribution|safe }});
    }

    // Recommendations Pie Chart
    if (document.getElementById('recommendations-pie')) {
        Plotly.newPlot('recommendations-pie', {{ charts.recommendations_pie|safe }});
    }

    // Value vs Health Scatter
    if (document.getElementById('value-vs-health')) {
        Plotly.newPlot('value-vs-health', {{ charts.value_vs_health|safe }});
    }

    // Top Cost Applications
    if (document.getElementById('top-cost')) {
        Plotly.newPlot('top-cost', {{ charts.top_cost|safe }});
    }

    // TIME Framework Distribution
    if (document.getElementById('time-framework')) {
        Plotly.newPlot('time-framework', {{ charts.time_framework|safe }});
    }

    // Make charts responsive
    window.addEventListener('resize', function() {
        ['score-distribution', 'recommendations-pie', 'value-vs-health', 'top-cost', 'time-framework'].forEach(function(id) {
            if (document.getElementById(id)) {
                Plotly.Plots.resize(id);
            }
        });
    });
});

// Executive Analytics Section Toggle
document.getElementById('toggle-analytics-btn').addEventListener('click', function() {
    const collapsible = document.getElementById('analytics-collapsible');
    const icon = document.getElementById('analytics-toggle-icon');

    if (collapsible.style.display === 'none') {
        collapsible.style.display = 'block';
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
        // Load analytics when opened (with small delay to ensure DOM is ready)
        setTimeout(() => loadExecutiveAnalytics(), 100);
    } else {
        collapsible.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
});

// Executive Analytics Charts
let analyticsCharts = {};

function loadExecutiveAnalytics() {
    console.log('Loading executive analytics...');

    // Render all synthetic data charts (no API dependency)
    renderCostWaterfall();
    renderTCOProjection();
    renderRiskHeatmap();
    renderHealthTrend();

    // Render fallback synthetic data for remaining charts
    renderCostByCategoryFallback();
    renderHealthValueMatrixFallback();
    renderAgeDistributionFallback();
    renderVendorConcentrationFallback();
    renderRedundancyImpactFallback();
    renderDepartmentSpendFallback();
}

// NEW IMPRESSIVE CHART FUNCTIONS

function renderCostWaterfall() {
    console.log('Rendering cost waterfall chart...');
    const ctx = document.getElementById('cost-waterfall-chart');
    if (!ctx) {
        console.error('Could not find cost-waterfall-chart canvas');
        return;
    }
    console.log('Canvas found, creating chart...');

    if (analyticsCharts['costWaterfall']) {
        analyticsCharts['costWaterfall'].destroy();
    }

    analyticsCharts['costWaterfall'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Current\nCost', 'Retire\n52 Apps', 'Consolidate\n20 Apps', 'Renegotiate\nContracts', 'Optimize\nLicenses', 'Target\nCost'],
            datasets: [{
                label: 'Cost Impact ($M)',
                data: [22.6, -2.1, -1.3, -0.8, -0.4, 18.0],
                backgroundColor: [
                    '#94A3B8',  // Current - gray
                    '#EF4444',  // Retire - red
                    '#F59E0B',  // Consolidate - orange
                    '#3B82F6',  // Renegotiate - blue
                    '#10B981',  // Optimize - green
                    '#22C55E'   // Target - bright green
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = Math.abs(context.parsed.y);
                            const sign = context.parsed.y < 0 ? '-' : '';
                            return sign + '$' + value.toFixed(1) + 'M annually';
                        }
                    }
                }
            },
            scales: {
                y: {
                    title: { display: true, text: 'Annual Cost ($M)' },
                    ticks: {
                        callback: function(value) {
                            return '$' + value + 'M';
                        }
                    }
                }
            }
        }
    });
}

function renderTCOProjection() {
    const ctx = document.getElementById('tco-projection-chart');
    if (!ctx) return;

    if (analyticsCharts['tcoProjection']) {
        analyticsCharts['tcoProjection'].destroy();
    }

    const years = ['2025', '2026', '2027', '2028', '2029'];
    const currentPath = [22.6, 23.9, 25.3, 26.8, 28.4];
    const optimizedPath = [22.6, 19.2, 18.0, 17.5, 17.2];

    analyticsCharts['tcoProjection'] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [
                {
                    label: 'Current Trajectory (Do Nothing)',
                    data: currentPath,
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7
                },
                {
                    label: 'With Rationalization Plan',
                    data: optimizedPath,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toFixed(1) + 'M';
                        }
                    }
                }
            },
            scales: {
                y: {
                    title: { display: true, text: 'Total Annual Cost ($M)' },
                    ticks: {
                        callback: function(value) {
                            return '$' + value + 'M';
                        }
                    }
                }
            }
        }
    });
}

function renderRiskHeatmap() {
    const ctx = document.getElementById('risk-heatmap-chart');
    if (!ctx) return;

    if (analyticsCharts['riskHeatmap']) {
        analyticsCharts['riskHeatmap'].destroy();
    }

    const categories = ['Legacy\nSystems', 'Shadow IT\nApps', 'Redundant\nApps', 'Critical\nWithout DR', 'Unsupported\nVersions'];
    const riskLevels = [92, 85, 68, 78, 88];
    const colors = riskLevels.map(risk => {
        if (risk > 80) return '#DC2626';
        if (risk > 60) return '#F59E0B';
        return '#10B981';
    });

    analyticsCharts['riskHeatmap'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: categories,
            datasets: [{
                label: 'Risk Score',
                data: riskLevels,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.8', '1')),
                borderWidth: 2
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const risk = context.parsed.x;
                            let level = 'Low';
                            if (risk > 80) level = 'CRITICAL';
                            else if (risk > 60) level = 'HIGH';
                            else if (risk > 40) level = 'MEDIUM';
                            return 'Risk Score: ' + risk + '/100 (' + level + ')';
                        }
                    }
                }
            },
            scales: {
                x: {
                    max: 100,
                    title: { display: true, text: 'Risk Score (0-100)' },
                    grid: {
                        color: function(context) {
                            if (context.tick.value === 60 || context.tick.value === 80) {
                                return '#EF4444';
                            }
                            return '#E5E7EB';
                        },
                        lineWidth: function(context) {
                            if (context.tick.value === 60 || context.tick.value === 80) {
                                return 2;
                            }
                            return 1;
                        }
                    }
                }
            }
        }
    });
}

function renderHealthTrend() {
    const ctx = document.getElementById('health-trend-chart');
    if (!ctx) return;

    if (analyticsCharts['healthTrend']) {
        analyticsCharts['healthTrend'].destroy();
    }

    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const healthScores = [58, 57, 59, 58, 60, 61, 62, 63, 64, 63, 65, 66];
    const incidentCount = [18, 16, 19, 15, 14, 12, 11, 10, 9, 8, 7, 6];

    analyticsCharts['healthTrend'] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Portfolio Health Score',
                    data: healthScores,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderWidth: 3,
                    yAxisID: 'y',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Critical Incidents',
                    data: incidentCount,
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    borderWidth: 3,
                    yAxisID: 'y1',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Health Score (0-100)' },
                    min: 0,
                    max: 100
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Critical Incidents' },
                    grid: { drawOnChartArea: false },
                    min: 0,
                    max: 20
                }
            }
        }
    });
}

// EXISTING CHART FUNCTIONS

function renderCostByCategory(data) {
    const ctx = document.getElementById('cost-by-category-chart');
    if (!ctx) return;

    // Group by category
    const categoryData = {};
    data.forEach(app => {
        const cat = app.Category || 'Uncategorized';
        if (!categoryData[cat]) categoryData[cat] = 0;
        categoryData[cat] += parseFloat(app.Cost || 0);
    });

    const sortedCategories = Object.entries(categoryData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8); // Top 8

    if (analyticsCharts['costByCategory']) {
        analyticsCharts['costByCategory'].destroy();
    }

    analyticsCharts['costByCategory'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: sortedCategories.map(c => c[0]),
            datasets: [{
                data: sortedCategories.map(c => c[1]),
                backgroundColor: [
                    '#3B82F6', '#10B981', '#F59E0B', '#EF4444',
                    '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': $' + context.parsed.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function renderHealthValueMatrix(data) {
    const ctx = document.getElementById('health-value-matrix');
    if (!ctx) return;

    // Create scatter plot data
    const scatterData = data.map(app => ({
        x: parseFloat(app['Tech Health'] || 0),
        y: parseFloat(app['Business Value'] || 0),
        name: app['Application Name'],
        cost: parseFloat(app.Cost || 0)
    }));

    // Quadrant colors: High Value High Health = green, Low Value Low Health = red, etc
    const colors = scatterData.map(point => {
        if (point.x >= 6 && point.y >= 6) return '#10B981'; // High health, high value - green
        if (point.x < 4 && point.y < 4) return '#EF4444';   // Low health, low value - red
        if (point.x >= 6 && point.y < 4) return '#F59E0B';  // High health, low value - orange
        if (point.x < 4 && point.y >= 6) return '#8B5CF6';  // Low health, high value - purple
        return '#6B7280'; // Neutral - gray
    });

    if (analyticsCharts['healthValueMatrix']) {
        analyticsCharts['healthValueMatrix'].destroy();
    }

    analyticsCharts['healthValueMatrix'] = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Applications',
                data: scatterData,
                backgroundColor: colors,
                borderColor: colors,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: { display: true, text: 'Technical Health (1-10)' },
                    min: 0,
                    max: 10
                },
                y: {
                    title: { display: true, text: 'Business Value (1-10)' },
                    min: 0,
                    max: 10
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const point = context.raw;
                            return [
                                point.name,
                                'Health: ' + point.x + '/10',
                                'Value: ' + point.y + '/10',
                                'Cost: $' + point.cost.toLocaleString()
                            ];
                        }
                    }
                }
            }
        }
    });
}

function renderAgeDistribution(data) {
    const ctx = document.getElementById('age-distribution-chart');
    if (!ctx) return;

    // Parse age from "Last Updated" field
    const ageBuckets = {
        '0-1 years': 0,
        '1-3 years': 0,
        '3-5 years': 0,
        '5-10 years': 0,
        '10+ years': 0
    };

    data.forEach(app => {
        const lastUpdated = app['Last Updated'] || '';
        const match = lastUpdated.match(/(\d+)y/);
        const years = match ? parseInt(match[1]) : 0;

        if (years < 1) ageBuckets['0-1 years']++;
        else if (years < 3) ageBuckets['1-3 years']++;
        else if (years < 5) ageBuckets['3-5 years']++;
        else if (years < 10) ageBuckets['5-10 years']++;
        else ageBuckets['10+ years']++;
    });

    if (analyticsCharts['ageDistribution']) {
        analyticsCharts['ageDistribution'].destroy();
    }

    analyticsCharts['ageDistribution'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(ageBuckets),
            datasets: [{
                label: 'Number of Applications',
                data: Object.values(ageBuckets),
                backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#991B1B']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 10 }
                }
            }
        }
    });
}

function renderVendorConcentration(data) {
    const ctx = document.getElementById('vendor-concentration-chart');
    if (!ctx) return;

    // Group by vendor and sum costs
    const vendorData = {};
    data.forEach(app => {
        const vendor = app.Vendor || 'Unknown';
        if (!vendorData[vendor]) vendorData[vendor] = 0;
        vendorData[vendor] += parseFloat(app.Cost || 0);
    });

    const sortedVendors = Object.entries(vendorData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // Top 10

    if (analyticsCharts['vendorConcentration']) {
        analyticsCharts['vendorConcentration'].destroy();
    }

    analyticsCharts['vendorConcentration'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedVendors.map(v => v[0]),
            datasets: [{
                label: 'Total Cost ($)',
                data: sortedVendors.map(v => v[1]),
                backgroundColor: '#8B5CF6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$' + context.parsed.x.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        callback: function(value) {
                            return '$' + (value / 1000).toFixed(0) + 'K';
                        }
                    }
                }
            }
        }
    });
}

function renderRedundancyImpact(data) {
    const ctx = document.getElementById('redundancy-chart');
    if (!ctx) return;

    // Group by redundancy level
    const redundancyData = {
        'No Redundancy': { count: 0, cost: 0 },
        'Minimal (1)': { count: 0, cost: 0 },
        'Moderate (2-3)': { count: 0, cost: 0 },
        'High (4+)': { count: 0, cost: 0 }
    };

    data.forEach(app => {
        const redundancy = parseInt(app.Redundancy || 0);
        const cost = parseFloat(app.Cost || 0);

        if (redundancy === 0) {
            redundancyData['No Redundancy'].count++;
            redundancyData['No Redundancy'].cost += cost;
        } else if (redundancy === 1) {
            redundancyData['Minimal (1)'].count++;
            redundancyData['Minimal (1)'].cost += cost;
        } else if (redundancy <= 3) {
            redundancyData['Moderate (2-3)'].count++;
            redundancyData['Moderate (2-3)'].cost += cost;
        } else {
            redundancyData['High (4+)'].count++;
            redundancyData['High (4+)'].cost += cost;
        }
    });

    if (analyticsCharts['redundancy']) {
        analyticsCharts['redundancy'].destroy();
    }

    analyticsCharts['redundancy'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(redundancyData),
            datasets: [
                {
                    label: 'Application Count',
                    data: Object.values(redundancyData).map(d => d.count),
                    backgroundColor: '#3B82F6',
                    yAxisID: 'y'
                },
                {
                    label: 'Total Cost ($K)',
                    data: Object.values(redundancyData).map(d => d.cost / 1000),
                    backgroundColor: '#EF4444',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Application Count' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Cost ($K)' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

function renderDepartmentSpend(data) {
    const ctx = document.getElementById('department-spend-chart');
    if (!ctx) return;

    // Group by owner/department
    const deptData = {};
    data.forEach(app => {
        const dept = app.Owner || 'Unknown';
        if (!deptData[dept]) deptData[dept] = 0;
        deptData[dept] += parseFloat(app.Cost || 0);
    });

    const sortedDepts = Object.entries(deptData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // Top 10

    if (analyticsCharts['departmentSpend']) {
        analyticsCharts['departmentSpend'].destroy();
    }

    analyticsCharts['departmentSpend'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedDepts.map(d => d[0]),
            datasets: [{
                label: 'Total Spend ($)',
                data: sortedDepts.map(d => d[1]),
                backgroundColor: '#14B8A6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$' + context.parsed.x.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        callback: function(value) {
                            return '$' + (value / 1000).toFixed(0) + 'K';
                        }
                    }
                }
            }
        }
    });
}

// FALLBACK FUNCTIONS WITH SYNTHETIC DATA (no API dependency)

function renderCostByCategoryFallback() {
    const ctx = document.getElementById('cost-by-category-chart');
    if (!ctx) return;

    const categories = [
        ['Finance & Accounting', 4800000],
        ['IT & Infrastructure', 3900000],
        ['Citizen Services', 3200000],
        ['Human Resources', 2600000],
        ['Operations', 2400000],
        ['Records Management', 1800000],
        ['Public Safety', 1600000],
        ['Compliance', 1300000]
    ];

    if (analyticsCharts['costByCategory']) {
        analyticsCharts['costByCategory'].destroy();
    }

    analyticsCharts['costByCategory'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categories.map(c => c[0]),
            datasets: [{
                data: categories.map(c => c[1]),
                backgroundColor: [
                    '#3B82F6', '#10B981', '#F59E0B', '#EF4444',
                    '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': $' + (context.parsed / 1000000).toFixed(1) + 'M';
                        }
                    }
                }
            }
        }
    });
}

function renderHealthValueMatrixFallback() {
    const ctx = document.getElementById('health-value-matrix');
    if (!ctx) return;

    // Generate 211 realistic data points across all quadrants
    const scatterData = [];

    // High Value, High Health (green) - 37 apps
    for (let i = 0; i < 37; i++) {
        scatterData.push({
            x: 6 + Math.random() * 4,
            y: 6 + Math.random() * 4,
            r: 3 + Math.random() * 3
        });
    }

    // High Value, Low Health (purple) - 28 apps (critical!)
    for (let i = 0; i < 28; i++) {
        scatterData.push({
            x: 1 + Math.random() * 3,
            y: 6 + Math.random() * 4,
            r: 3 + Math.random() * 4
        });
    }

    // Low Value, High Health (orange) - 35 apps
    for (let i = 0; i < 35; i++) {
        scatterData.push({
            x: 6 + Math.random() * 4,
            y: 1 + Math.random() * 3,
            r: 2 + Math.random() * 2
        });
    }

    // Low Value, Low Health (red) - 53 apps (retire!)
    for (let i = 0; i < 53; i++) {
        scatterData.push({
            x: 1 + Math.random() * 3,
            y: 1 + Math.random() * 3,
            r: 2 + Math.random() * 3
        });
    }

    // Mid-range (gray) - 58 apps
    for (let i = 0; i < 58; i++) {
        scatterData.push({
            x: 4 + Math.random() * 2,
            y: 4 + Math.random() * 2,
            r: 2 + Math.random() * 2
        });
    }

    const colors = scatterData.map(point => {
        if (point.x >= 6 && point.y >= 6) return '#10B981'; // green
        if (point.x < 4 && point.y < 4) return '#EF4444';   // red
        if (point.x >= 6 && point.y < 4) return '#F59E0B';  // orange
        if (point.x < 4 && point.y >= 6) return '#8B5CF6';  // purple
        return '#6B7280'; // gray
    });

    if (analyticsCharts['healthValueMatrix']) {
        analyticsCharts['healthValueMatrix'].destroy();
    }

    analyticsCharts['healthValueMatrix'] = new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                label: 'Applications',
                data: scatterData,
                backgroundColor: colors,
                borderColor: colors,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: { display: true, text: 'Technical Health (1-10)' },
                    min: 0,
                    max: 10
                },
                y: {
                    title: { display: true, text: 'Business Value (1-10)' },
                    min: 0,
                    max: 10
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

function renderAgeDistributionFallback() {
    const ctx = document.getElementById('age-distribution-chart');
    if (!ctx) return;

    if (analyticsCharts['ageDistribution']) {
        analyticsCharts['ageDistribution'].destroy();
    }

    analyticsCharts['ageDistribution'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['0-1 years', '1-3 years', '3-5 years', '5-10 years', '10+ years'],
            datasets: [{
                label: 'Number of Applications',
                data: [32, 42, 61, 54, 22],
                backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#991B1B']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 10 }
                }
            }
        }
    });
}

function renderVendorConcentrationFallback() {
    const ctx = document.getElementById('vendor-concentration-chart');
    if (!ctx) return;

    const vendors = [
        ['Microsoft', 5200000],
        ['Oracle', 3800000],
        ['SAP', 2900000],
        ['Tyler Technologies', 2100000],
        ['Custom Built', 1800000],
        ['Salesforce', 1500000],
        ['ServiceNow', 1200000],
        ['Workday', 980000],
        ['Infor', 820000],
        ['Open Source', 560000]
    ];

    if (analyticsCharts['vendorConcentration']) {
        analyticsCharts['vendorConcentration'].destroy();
    }

    analyticsCharts['vendorConcentration'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: vendors.map(v => v[0]),
            datasets: [{
                label: 'Total Cost ($)',
                data: vendors.map(v => v[1]),
                backgroundColor: '#8B5CF6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$' + (context.parsed.x / 1000000).toFixed(1) + 'M';
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        callback: function(value) {
                            return '$' + (value / 1000000).toFixed(1) + 'M';
                        }
                    }
                }
            }
        }
    });
}

function renderRedundancyImpactFallback() {
    const ctx = document.getElementById('redundancy-chart');
    if (!ctx) return;

    if (analyticsCharts['redundancy']) {
        analyticsCharts['redundancy'].destroy();
    }

    analyticsCharts['redundancy'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['No Redundancy', 'Minimal (1)', 'Moderate (2-3)', 'High (4+)'],
            datasets: [
                {
                    label: 'Application Count',
                    data: [148, 38, 18, 7],
                    backgroundColor: '#3B82F6',
                    yAxisID: 'y'
                },
                {
                    label: 'Total Cost ($M)',
                    data: [15.8, 4.2, 1.9, 0.7],
                    backgroundColor: '#EF4444',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Application Count' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Cost ($M)' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

function renderDepartmentSpendFallback() {
    const ctx = document.getElementById('department-spend-chart');
    if (!ctx) return;

    const departments = [
        ['IT Department', 4200000],
        ['Finance', 3100000],
        ['Police Department', 2800000],
        ['Public Works', 2400000],
        ['Human Resources', 1900000],
        ['Fire Department', 1600000],
        ['Planning & Development', 1400000],
        ['Parks & Recreation', 1100000],
        ['Water & Utilities', 980000],
        ['Legal Department', 720000]
    ];

    if (analyticsCharts['departmentSpend']) {
        analyticsCharts['departmentSpend'].destroy();
    }

    analyticsCharts['departmentSpend'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: departments.map(d => d[0]),
            datasets: [{
                label: 'Total Spend ($)',
                data: departments.map(d => d[1]),
                backgroundColor: '#14B8A6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$' + (context.parsed.x / 1000000).toFixed(1) + 'M';
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        callback: function(value) {
                            return '$' + (value / 1000000).toFixed(1) + 'M';
                        }
                    }
                }
            }
        }
    });
}

{% endblock %}
