{% extends "base.html" %}

{% block title %}Dashboard - Application Rationalization Tool{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Application Portfolio Overview{% endblock %}

{% block content %}
<!-- AI Executive Summary Section -->
<div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl shadow-lg p-6 mb-8 border border-blue-200">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-800">
            ðŸ¤– AI Executive Summary
        </h2>
        <button id="generate-summary-btn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg shadow-md transition-all duration-200 flex items-center gap-2">
            <i class="fas fa-magic"></i>
            Generate Summary
        </button>
    </div>

    <!-- Loading State -->
    <div id="summary-loading" class="hidden text-center py-8">
        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
        <p class="text-gray-600">Analyzing portfolio data...</p>
    </div>

    <!-- Summary Content -->
    <div id="summary-content" class="hidden">
        <!-- Overview Badge -->
        <div id="summary-overview" class="bg-white rounded-lg p-4 mb-4 border-l-4 border-blue-500">
            <p class="text-sm font-medium text-gray-700"></p>
        </div>

        <!-- Executive Narrative -->
        <div class="bg-white rounded-lg p-6 mb-4 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <i class="fas fa-file-alt text-indigo-600"></i>
                Executive Narrative
            </h3>
            <div id="summary-narrative" class="text-gray-700 leading-relaxed whitespace-pre-line"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Key Insights -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-lightbulb text-yellow-500"></i>
                    Key Insights
                </h3>
                <div id="summary-insights" class="space-y-3"></div>
            </div>

            <!-- Top Recommendations -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-tasks text-green-600"></i>
                    Top Recommendations
                </h3>
                <div id="summary-recommendations" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div id="summary-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex items-start gap-3">
            <i class="fas fa-exclamation-circle text-red-600 text-xl mt-1"></i>
            <div>
                <h4 class="font-semibold text-red-800 mb-1">Error Generating Summary</h4>
                <p id="summary-error-message" class="text-red-700 text-sm"></p>
            </div>
        </div>
    </div>
</div>

<!-- Predictive Cost & Risk Modeling Section -->
<div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl shadow-lg p-6 mb-8 border border-purple-200">
    <div class="flex items-center justify-between mb-4">
        <button id="toggle-predictions-btn" class="flex items-center gap-2 text-2xl font-bold text-gray-800 hover:text-purple-600 transition-colors">
            <i id="predictions-toggle-icon" class="fas fa-chevron-right text-lg"></i>
            ðŸ”® Predictive Cost & Risk Modeling
        </button>
        <button id="refresh-predictions-btn"
                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-6 py-2 rounded-lg shadow-md transition-all duration-200 flex items-center gap-2">
            <i class="fas fa-sync-alt"></i>
            Refresh Predictions
        </button>
    </div>

    <!-- Collapsible Container (starts collapsed) -->
    <div id="predictions-collapsible" class="space-y-4" style="display: none;">
        <!-- Loading State -->
        <div id="predictions-loading" class="hidden text-center py-8">
            <i class="fas fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
            <p class="text-gray-600">Analyzing future costs and risks...</p>
        </div>

        <!-- Predictions Content -->
        <div id="predictions-content" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Cost Forecast Chart -->
            <div class="lg:col-span-2 bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-line text-purple-600"></i>
                    3-Year Cost Forecast
                </h3>
                <canvas id="cost-forecast-chart" class="w-full" style="height: 200px;"></canvas>
            </div>

            <!-- ROI Analysis Card -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-piggy-bank text-green-600"></i>
                    ROI Analysis
                </h3>
                <div id="roi-analysis" class="space-y-4">
                    <!-- ROI metrics will be populated here -->
                </div>
            </div>
        </div>

        <!-- High-Risk Apps Table -->
        <div class="bg-white rounded-lg p-6 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-exclamation-triangle text-red-600"></i>
                Top 5 High-Risk Applications (Next 12 Months)
            </h3>
            <div class="overflow-x-auto max-h-80">
                <table id="high-risk-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tech Health</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Annual Cost</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk Score</th>
                        </tr>
                    </thead>
                    <tbody id="high-risk-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- High-risk apps will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

        <!-- Error State -->
        <div id="predictions-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-start gap-3">
                <i class="fas fa-exclamation-circle text-red-600 text-xl mt-1"></i>
                <div>
                    <h4 class="font-semibold text-red-800 mb-1">Error Generating Predictions</h4>
                    <p id="predictions-error-message" class="text-red-700 text-sm"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KPI Cards Section -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Applications Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Total Applications</p>
                <p class="text-3xl font-bold text-gray-800 mt-2">{{ kpis.total_apps }}</p>
                <p class="text-xs text-gray-400 mt-2">In portfolio</p>
            </div>
            <div class="bg-blue-100 rounded-full p-4">
                <i class="fas fa-laptop-code text-3xl text-blue-600"></i>
            </div>
        </div>
    </div>

    <!-- Average Score Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Average Score</p>
                <p class="text-3xl font-bold text-gray-800 mt-2">{{ "%.1f"|format(kpis.avg_score) }}</p>
                <p class="text-xs text-gray-400 mt-2">Out of 100</p>
            </div>
            <div class="bg-green-100 rounded-full p-4">
                <i class="fas fa-chart-line text-3xl text-green-600"></i>
            </div>
        </div>
    </div>

    <!-- Total Cost Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Total Cost</p>
                <p class="text-3xl font-bold text-gray-800 mt-2">${{ "{:,.0f}".format(kpis.total_cost) }}</p>
                <p class="text-xs text-gray-400 mt-2">Annual spend</p>
            </div>
            <div class="bg-yellow-100 rounded-full p-4">
                <i class="fas fa-dollar-sign text-3xl text-yellow-600"></i>
            </div>
        </div>
    </div>

    <!-- High Risk Count Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">High Risk Apps</p>
                <p class="text-3xl font-bold text-gray-800 mt-2">{{ kpis.high_risk_count }}</p>
                <p class="text-xs text-gray-400 mt-2">Requires attention</p>
            </div>
            <div class="bg-red-100 rounded-full p-4">
                <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
            </div>
        </div>
    </div>
</div>

<!-- Action Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Retire Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Retire</p>
                <p class="text-2xl font-bold text-gray-800 mt-2">{{ actions.retire }}</p>
                <p class="text-xs text-red-600 mt-2">Eliminate applications</p>
            </div>
            <div class="text-red-500">
                <i class="fas fa-times-circle text-3xl"></i>
            </div>
        </div>
    </div>

    <!-- Invest Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Invest</p>
                <p class="text-2xl font-bold text-gray-800 mt-2">{{ actions.invest }}</p>
                <p class="text-xs text-blue-600 mt-2">Strategic assets</p>
            </div>
            <div class="text-blue-500">
                <i class="fas fa-arrow-up text-3xl"></i>
            </div>
        </div>
    </div>

    <!-- Migrate Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Migrate</p>
                <p class="text-2xl font-bold text-gray-800 mt-2">{{ actions.migrate }}</p>
                <p class="text-xs text-purple-600 mt-2">Modernize tech</p>
            </div>
            <div class="text-purple-500">
                <i class="fas fa-exchange-alt text-3xl"></i>
            </div>
        </div>
    </div>

    <!-- Maintain Card -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Maintain</p>
                <p class="text-2xl font-bold text-gray-800 mt-2">{{ actions.maintain }}</p>
                <p class="text-xs text-yellow-600 mt-2">Keep as-is</p>
            </div>
            <div class="text-yellow-500">
                <i class="fas fa-check-circle text-3xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Score Distribution Chart -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
            Score Distribution
        </h3>
        <div id="score-distribution" class="w-full" style="height: 400px;"></div>
    </div>

    <!-- Recommendations Pie Chart -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-pie text-green-600 mr-2"></i>
            Recommendations Breakdown
        </h3>
        <div id="recommendations-pie" class="w-full" style="height: 400px;"></div>
    </div>
</div>

<!-- Value vs Health Scatter -->
<div class="bg-white rounded-xl shadow-md p-6 mb-8">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-project-diagram text-purple-600 mr-2"></i>
        Business Value vs Technical Health
    </h3>
    <div id="value-vs-health" class="w-full" style="height: 500px;"></div>
</div>

<!-- Bottom Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Top Cost Applications -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-money-bill-wave text-yellow-600 mr-2"></i>
            Top Cost Applications
        </h3>
        <div id="top-cost" class="w-full" style="height: 400px;"></div>
    </div>

    <!-- TIME Framework Distribution -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-th text-indigo-600 mr-2"></i>
            TIME Framework Distribution
        </h3>
        <div id="time-framework" class="w-full" style="height: 400px;"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
// Predictive Cost & Risk Modeling functionality
let costForecastChart = null;

// Toggle predictions section
document.getElementById('toggle-predictions-btn').addEventListener('click', function() {
    const collapsible = document.getElementById('predictions-collapsible');
    const icon = document.getElementById('predictions-toggle-icon');

    if (collapsible.style.display === 'none') {
        collapsible.style.display = 'block';
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
    } else {
        collapsible.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
});

async function loadPredictions() {
    const loadingDiv = document.getElementById('predictions-loading');
    const contentDiv = document.getElementById('predictions-content');
    const errorDiv = document.getElementById('predictions-error');
    const refreshBtn = document.getElementById('refresh-predictions-btn');

    // Reset state
    contentDiv.classList.add('hidden');
    errorDiv.classList.add('hidden');
    loadingDiv.classList.remove('hidden');
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

    try {
        const response = await fetch('/api/predictions');
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to generate predictions');
        }

        // 1. Render Cost Forecast Chart
        const costForecast = data.cost_forecast || [];
        if (costForecast.length > 0) {
            const ctx = document.getElementById('cost-forecast-chart').getContext('2d');

            // Destroy existing chart if it exists
            if (costForecastChart) {
                costForecastChart.destroy();
            }

            const currentYear = new Date().getFullYear();
            const labels = ['Current', ...costForecast.map(f => `Year ${f.year}`)];
            const currentCost = costForecast.length > 0 ? costForecast[0].projected_cost / (1 + costForecast[0].growth_rate) : 0;
            const costs = [currentCost, ...costForecast.map(f => f.projected_cost)];

            costForecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Projected Portfolio Cost',
                        data: costs,
                        borderColor: '#9333EA',
                        backgroundColor: 'rgba(147, 51, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#9333EA',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Cost: $' + context.parsed.y.toLocaleString('en-US', {maximumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 2. Render ROI Analysis
        const roiAnalysis = data.roi_analysis || {};
        const roiDiv = document.getElementById('roi-analysis');
        roiDiv.innerHTML = '';

        if (roiAnalysis.retire_count > 0) {
            const roiHtml = `
                <div class="space-y-3">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <p class="text-xs text-gray-600 mb-1">Apps to Retire</p>
                        <p class="text-2xl font-bold text-blue-700">${roiAnalysis.retire_count}</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                        <p class="text-xs text-gray-600 mb-1">Annual Savings</p>
                        <p class="text-2xl font-bold text-green-700">$${(roiAnalysis.annual_savings / 1000000).toFixed(2)}M</p>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                        <p class="text-xs text-gray-600 mb-1">Migration Cost</p>
                        <p class="text-2xl font-bold text-yellow-700">$${(roiAnalysis.migration_cost / 1000000).toFixed(2)}M</p>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                        <p class="text-xs text-gray-600 mb-1">Payback Period</p>
                        <p class="text-2xl font-bold text-purple-700">${roiAnalysis.payback_months.toFixed(1)} mo</p>
                    </div>
                    <div class="${roiAnalysis.three_year_roi > 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} p-3 rounded-lg border">
                        <p class="text-xs text-gray-600 mb-1">3-Year ROI</p>
                        <p class="text-2xl font-bold ${roiAnalysis.three_year_roi > 0 ? 'text-green-700' : 'text-red-700'}">
                            ${roiAnalysis.three_year_roi > 0 ? '+' : ''}$${(roiAnalysis.three_year_roi / 1000000).toFixed(2)}M
                        </p>
                    </div>
                </div>
            `;
            roiDiv.innerHTML = roiHtml;
        } else {
            roiDiv.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-info-circle text-4xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 text-sm">No retirement candidates identified</p>
                </div>
            `;
        }

        // 3. Render High-Risk Apps Table (limit to top 5)
        const highRiskApps = (data.high_risk_apps || []).slice(0, 5);
        const tbody = document.getElementById('high-risk-tbody');
        tbody.innerHTML = '';

        if (highRiskApps.length > 0) {
            highRiskApps.forEach(app => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                // Risk score color coding
                let riskClass = 'bg-yellow-100 text-yellow-800';
                if (app.risk_score > 50) {
                    riskClass = 'bg-red-100 text-red-800';
                } else if (app.risk_score > 30) {
                    riskClass = 'bg-orange-100 text-orange-800';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${app.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span class="px-2 py-1 text-xs font-semibold bg-gray-100 rounded">${app.technical_health.toFixed(1)}/10</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">$${app.annual_cost.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-3 py-1 rounded-full font-semibold ${riskClass}">${app.risk_score.toFixed(1)}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                        <i class="fas fa-check-circle text-4xl text-green-500 mb-2"></i>
                        <p>No high-risk applications identified</p>
                    </td>
                </tr>
            `;
        }

        // Show content
        loadingDiv.classList.add('hidden');
        contentDiv.classList.remove('hidden');

    } catch (error) {
        console.error('Error loading predictions:', error);
        loadingDiv.classList.add('hidden');
        errorDiv.classList.remove('hidden');
        document.getElementById('predictions-error-message').textContent = error.message;
    } finally {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Predictions';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refresh-predictions-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadPredictions);
        // Auto-load predictions on page load
        loadPredictions();
    }
});

// AI Executive Summary functionality
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-summary-btn');
    const loadingDiv = document.getElementById('summary-loading');
    const contentDiv = document.getElementById('summary-content');
    const errorDiv = document.getElementById('summary-error');

    if (generateBtn) {
        generateBtn.addEventListener('click', async function() {
            // Reset state
            contentDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

            try {
                const response = await fetch('/api/ai/summary');
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to generate summary');
                }

                // Display overview
                document.querySelector('#summary-overview p').textContent = data.overview;

                // Display narrative
                document.getElementById('summary-narrative').textContent = data.narrative;

                // Display insights with color coding
                const insightsDiv = document.getElementById('summary-insights');
                insightsDiv.innerHTML = '';

                if (data.insights && data.insights.length > 0) {
                    // Show max 5 insights
                    data.insights.slice(0, 5).forEach(insight => {
                        const insightEl = document.createElement('div');

                        let icon = 'ðŸ”µ';
                        let colorClass = 'border-blue-500 bg-blue-50';

                        if (insight.type === 'critical') {
                            icon = 'ðŸ”´';
                            colorClass = 'border-red-500 bg-red-50';
                        } else if (insight.type === 'warning') {
                            icon = 'ðŸŸ¡';
                            colorClass = 'border-yellow-500 bg-yellow-50';
                        } else if (insight.type === 'opportunity') {
                            icon = 'ðŸŸ¢';
                            colorClass = 'border-green-500 bg-green-50';
                        }

                        insightEl.className = `p-3 rounded-lg border-l-4 ${colorClass}`;
                        insightEl.innerHTML = `
                            <div class="flex items-start gap-2">
                                <span class="text-lg">${icon}</span>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-800">${insight.category || 'Insight'}</p>
                                    <p class="text-sm text-gray-700 mt-1">${insight.message}</p>
                                </div>
                            </div>
                        `;
                        insightsDiv.appendChild(insightEl);
                    });
                } else {
                    insightsDiv.innerHTML = '<p class="text-gray-500 text-sm">No significant insights identified.</p>';
                }

                // Display recommendations
                const recsDiv = document.getElementById('summary-recommendations');
                recsDiv.innerHTML = '';

                if (data.recommendations && data.recommendations.length > 0) {
                    // Show top 3 recommendations
                    data.recommendations.slice(0, 3).forEach((rec, index) => {
                        const recEl = document.createElement('div');

                        let priorityBadge = '';
                        if (rec.priority === 'high') {
                            priorityBadge = '<span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded">HIGH</span>';
                        } else if (rec.priority === 'medium') {
                            priorityBadge = '<span class="px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded">MEDIUM</span>';
                        } else {
                            priorityBadge = '<span class="px-2 py-1 text-xs font-semibold bg-blue-100 text-blue-800 rounded">LOW</span>';
                        }

                        recEl.className = 'p-4 rounded-lg border border-gray-200 bg-gray-50';
                        recEl.innerHTML = `
                            <div class="flex items-start justify-between gap-2 mb-2">
                                <span class="font-semibold text-gray-800">${index + 1}.</span>
                                ${priorityBadge}
                            </div>
                            <p class="text-sm text-gray-800 font-medium mb-2">${rec.action}</p>
                            <div class="flex items-center gap-4 text-xs text-gray-600">
                                <span><i class="far fa-clock mr-1"></i>${rec.timeline}</span>
                                <span><i class="fas fa-bullseye mr-1"></i>${rec.category || 'General'}</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-2 italic">${rec.impact}</p>
                        `;
                        recsDiv.appendChild(recEl);
                    });
                } else {
                    recsDiv.innerHTML = '<p class="text-gray-500 text-sm">No recommendations available.</p>';
                }

                // Show content
                loadingDiv.classList.add('hidden');
                contentDiv.classList.remove('hidden');

            } catch (error) {
                console.error('Error generating AI summary:', error);
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
                document.getElementById('summary-error-message').textContent = error.message;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Regenerate Summary';
            }
        });
    }
});

// Render Plotly charts
document.addEventListener('DOMContentLoaded', function() {
    // Score Distribution Chart
    if (document.getElementById('score-distribution')) {
        Plotly.newPlot('score-distribution', {{ charts.score_distribution|safe }});
    }

    // Recommendations Pie Chart
    if (document.getElementById('recommendations-pie')) {
        Plotly.newPlot('recommendations-pie', {{ charts.recommendations_pie|safe }});
    }

    // Value vs Health Scatter
    if (document.getElementById('value-vs-health')) {
        Plotly.newPlot('value-vs-health', {{ charts.value_vs_health|safe }});
    }

    // Top Cost Applications
    if (document.getElementById('top-cost')) {
        Plotly.newPlot('top-cost', {{ charts.top_cost|safe }});
    }

    // TIME Framework Distribution
    if (document.getElementById('time-framework')) {
        Plotly.newPlot('time-framework', {{ charts.time_framework|safe }});
    }

    // Make charts responsive
    window.addEventListener('resize', function() {
        ['score-distribution', 'recommendations-pie', 'value-vs-health', 'top-cost', 'time-framework'].forEach(function(id) {
            if (document.getElementById(id)) {
                Plotly.Plots.resize(id);
            }
        });
    });
});
{% endblock %}
