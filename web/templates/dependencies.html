{% extends "base.html" %}

{% block title %}Integration & Dependency Mapping{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Integration & Dependency Mapping</h1>
        <p class="text-gray-600">Visualize application dependencies, identify hub applications, and analyze blast radius</p>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="text-center py-12">
        <i class="fas fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
        <p class="text-gray-600">Analyzing integration architecture...</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Total Dependencies</p>
                        <p id="total-deps" class="text-3xl font-bold text-gray-800">-</p>
                    </div>
                    <i class="fas fa-project-diagram text-3xl text-blue-500"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Hub Applications</p>
                        <p id="hub-count" class="text-3xl font-bold text-gray-800">-</p>
                    </div>
                    <i class="fas fa-network-wired text-3xl text-purple-500"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Circular Dependencies</p>
                        <p id="cycle-count" class="text-3xl font-bold text-gray-800">-</p>
                    </div>
                    <i class="fas fa-sync-alt text-3xl text-red-500"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Complexity Rating</p>
                        <p id="complexity-rating" class="text-lg font-semibold text-gray-800">-</p>
                    </div>
                    <i class="fas fa-chart-line text-3xl text-green-500"></i>
                </div>
            </div>
        </div>

        <!-- Dependency Graph Visualization -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-sitemap text-purple-600 mr-2"></i>
                    Dependency Graph
                </h2>
                <div class="flex gap-2">
                    <button id="reset-zoom-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-compress-arrows-alt mr-2"></i>Reset Zoom
                    </button>
                    <button id="export-graph-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                </div>
            </div>

            <!-- Legend -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <p class="font-semibold text-gray-700 mb-2">Legend:</p>
                <div class="flex flex-wrap gap-4">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-green-500"></div>
                        <span class="text-sm text-gray-600">Healthy (High health + value)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-purple-500"></div>
                        <span class="text-sm text-gray-600">Modernize (Low health, high value)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-red-500"></div>
                        <span class="text-sm text-gray-600">Retire (Low health + value)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-yellow-500"></div>
                        <span class="text-sm text-gray-600">Low Value</span>
                    </div>
                </div>
            </div>

            <!-- Graph Container -->
            <div id="graph-container" class="border border-gray-200 rounded-lg bg-gray-50" style="height: 600px; position: relative;">
                <div id="graph-empty-state" class="hidden absolute inset-0 flex items-center justify-center">
                    <div class="text-center">
                        <i class="fas fa-project-diagram text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No dependencies found in portfolio</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hub Applications -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-network-wired text-purple-600 mr-2"></i>
                Hub Applications
            </h2>
            <div id="hub-applications-table" class="overflow-x-auto">
                <p class="text-gray-500 text-center py-8">Loading hub applications...</p>
            </div>
        </div>

        <!-- Critical Path -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-route text-red-600 mr-2"></i>
                Critical Path Analysis
            </h2>
            <div id="critical-path-content">
                <p class="text-gray-500 text-center py-8">Analyzing critical path...</p>
            </div>
        </div>

        <!-- Circular Dependencies -->
        <div id="circular-deps-section" class="bg-white rounded-lg shadow-lg p-6 mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-sync-alt text-red-600 mr-2"></i>
                Circular Dependencies
            </h2>
            <div id="circular-deps-content"></div>
        </div>

        <!-- Recommendations -->
        <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                Recommendations
            </h2>
            <div id="recommendations-list" class="space-y-3">
                <p class="text-gray-500">Loading recommendations...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
// Load Vis.js for network visualization
const script = document.createElement('script');
script.src = 'https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js';
script.onload = initializePage;
document.head.appendChild(script);

const link = document.createElement('link');
link.rel = 'stylesheet';
link.href = 'https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/dist/vis-network.min.css';
document.head.appendChild(link);

let network = null;
let reportData = null;

function initializePage() {
    loadIntegrationReport();
}

async function loadIntegrationReport() {
    try {
        const response = await fetch('/api/dependencies/report');
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to load integration report');
        }

        reportData = data.dependency_report;

        // Update summary cards
        updateSummaryCards(reportData);

        // Render dependency graph
        renderDependencyGraph(reportData.graph_data);

        // Render hub applications
        renderHubApplications(reportData.hub_applications);

        // Render critical path
        renderCriticalPath(reportData.critical_path);

        // Render circular dependencies
        if (reportData.circular_dependencies && reportData.circular_dependencies.length > 0) {
            renderCircularDependencies(reportData.circular_dependencies);
        }

        // Render recommendations
        renderRecommendations(reportData.recommendations);

        // Show main content
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');

    } catch (error) {
        console.error('Error loading integration report:', error);
        document.getElementById('loading-state').innerHTML = `
            <i class="fas fa-exclamation-triangle text-4xl text-red-600 mb-4"></i>
            <p class="text-red-600">Error loading integration data: ${error.message}</p>
        `;
    }
}

function updateSummaryCards(report) {
    document.getElementById('total-deps').textContent = report.complexity_score.total_dependencies || 0;
    document.getElementById('hub-count').textContent = report.hub_applications.length || 0;
    document.getElementById('cycle-count').textContent = report.circular_dependencies.length || 0;
    document.getElementById('complexity-rating').textContent = report.complexity_score.complexity_rating.split(' - ')[0] || 'Low';
}

function renderDependencyGraph(graphData) {
    if (!graphData.nodes || graphData.nodes.length === 0) {
        document.getElementById('graph-empty-state').classList.remove('hidden');
        return;
    }

    // Prepare data for Vis.js
    const nodes = new vis.DataSet(graphData.nodes.map(node => ({
        id: node.id,
        label: node.label,
        title: `${node.label}\nHealth: ${node.health}\nValue: ${node.value}\nConnections: ${node.connections}`,
        size: node.size,
        color: node.color,
        font: { size: 12 }
    })));

    const edges = new vis.DataSet(graphData.edges.map(edge => ({
        from: edge.source,
        to: edge.target,
        arrows: 'to',
        color: { color: '#666666', opacity: 0.6 }
    })));

    const container = document.getElementById('graph-container');
    const data = { nodes, edges };

    const options = {
        physics: {
            stabilization: { iterations: 200 },
            barnesHut: {
                gravitationalConstant: -2000,
                centralGravity: 0.3,
                springLength: 95,
                springConstant: 0.04
            }
        },
        interaction: {
            hover: true,
            tooltipDelay: 100
        },
        nodes: {
            shape: 'dot',
            font: {
                size: 12,
                color: '#333333'
            },
            borderWidth: 2,
            borderWidthSelected: 4
        }
    };

    network = new vis.Network(container, data, options);

    // Reset zoom button
    document.getElementById('reset-zoom-btn').addEventListener('click', () => {
        network.fit({ animation: true });
    });

    // Export button
    document.getElementById('export-graph-btn').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(graphData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'dependency_graph.json';
        a.click();
    });
}

function renderHubApplications(hubs) {
    if (!hubs || hubs.length === 0) {
        document.getElementById('hub-applications-table').innerHTML = '<p class="text-gray-500 text-center py-4">No hub applications found</p>';
        return;
    }

    const html = `
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Application</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hub Score</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Incoming</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Outgoing</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Health</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Risk Level</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                ${hubs.slice(0, 10).map(hub => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${hub.app_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-700">${hub.hub_score}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-700">${hub.incoming_connections}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-700">${hub.outgoing_connections}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full ${hub.health >= 7 ? 'bg-green-100 text-green-800' : hub.health >= 5 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                ${hub.health}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full ${hub.risk_level.includes('Critical') ? 'bg-red-100 text-red-800' : hub.risk_level.includes('High') ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'}">
                                ${hub.risk_level.split(' - ')[0]}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="viewBlastRadius('${hub.app_name}')" class="text-purple-600 hover:text-purple-800 font-medium">
                                View Blast Radius
                            </button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    document.getElementById('hub-applications-table').innerHTML = html;
}

function renderCriticalPath(criticalPath) {
    if (!criticalPath || !criticalPath.path || criticalPath.path.length === 0) {
        document.getElementById('critical-path-content').innerHTML = '<p class="text-gray-500 text-center py-4">No critical path identified</p>';
        return;
    }

    const html = `
        <div class="mb-4 p-4 bg-blue-50 rounded-lg">
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <p class="text-sm text-gray-600">Path Length</p>
                    <p class="text-2xl font-bold text-gray-800">${criticalPath.path_length} apps</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Total Cost</p>
                    <p class="text-2xl font-bold text-gray-800">$${(criticalPath.total_cost / 1000000).toFixed(1)}M</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Average Health</p>
                    <p class="text-2xl font-bold text-gray-800">${criticalPath.avg_health}</p>
                </div>
            </div>
        </div>
        ${criticalPath.weakest_link ? `
            <div class="mb-4 p-4 bg-red-50 rounded-lg border-l-4 border-red-500">
                <p class="font-semibold text-red-800">Weakest Link:</p>
                <p class="text-red-700">${criticalPath.weakest_link.app_name} (Health: ${criticalPath.weakest_link.health})</p>
            </div>
        ` : ''}
        <div class="flex items-center space-x-2 overflow-x-auto pb-4">
            ${criticalPath.path.map((app, idx) => `
                <div class="flex items-center">
                    <div class="bg-white border-2 border-gray-300 rounded-lg p-3 min-w-[150px]">
                        <p class="font-medium text-gray-800 text-sm">${app.app_name}</p>
                        <p class="text-xs text-gray-600">Health: ${app.health}</p>
                        <p class="text-xs text-gray-600">Value: ${app.value}</p>
                    </div>
                    ${idx < criticalPath.path.length - 1 ? '<i class="fas fa-arrow-right text-gray-400 mx-2"></i>' : ''}
                </div>
            `).join('')}
        </div>
    `;

    document.getElementById('critical-path-content').innerHTML = html;
}

function renderCircularDependencies(cycles) {
    if (!cycles || cycles.length === 0) return;

    const section = document.getElementById('circular-deps-section');
    section.classList.remove('hidden');

    const html = cycles.map(cycle => `
        <div class="mb-4 p-4 border-l-4 border-red-500 bg-red-50 rounded">
            <p class="font-semibold text-red-800 mb-2">Cycle of ${cycle.cycle_length} applications:</p>
            <p class="text-red-700">${cycle.cycle.join(' â†’ ')}</p>
            <p class="text-sm text-red-600 mt-2">Severity: ${cycle.severity}</p>
        </div>
    `).join('');

    document.getElementById('circular-deps-content').innerHTML = html;
}

function renderRecommendations(recommendations) {
    if (!recommendations || recommendations.length === 0) {
        document.getElementById('recommendations-list').innerHTML = '<p class="text-gray-500">No recommendations available</p>';
        return;
    }

    const html = recommendations.map(rec => `
        <div class="flex items-start gap-3 bg-white p-4 rounded-lg shadow">
            <i class="fas fa-check-circle text-green-500 text-xl mt-1"></i>
            <p class="text-gray-700">${rec}</p>
        </div>
    `).join('');

    document.getElementById('recommendations-list').innerHTML = html;
}

async function viewBlastRadius(appName) {
    try {
        const response = await fetch(`/api/dependencies/blast-radius/${encodeURIComponent(appName)}`);
        const data = await response.json();

        if (!response.ok) throw new Error(data.error);

        const blast = data.blast_radius;

        alert(`Blast Radius Analysis: ${appName}\n\n` +
              `Directly Affected: ${blast.directly_affected} apps\n` +
              `Total Affected: ${blast.total_affected} apps\n` +
              `Cost at Risk: $${(blast.total_cost_at_risk / 1000).toFixed(0)}K\n` +
              `Risk Category: ${blast.risk_category}`);

    } catch (error) {
        alert('Error calculating blast radius: ' + error.message);
    }
}
{% endblock %}
