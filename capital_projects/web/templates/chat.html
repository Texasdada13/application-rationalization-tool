{% extends "base.html" %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Chat Interface -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow h-full flex flex-col">
            <!-- Chat Header -->
            <div class="p-4 border-b bg-gradient-to-r from-blue-600 to-blue-700 rounded-t-lg">
                <h3 class="text-lg font-semibold text-white flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>
                    Project Assistant
                </h3>
                <p class="text-blue-100 text-sm">Ask me anything about your capital projects portfolio</p>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4" style="min-height: 400px; max-height: 500px;">
                <!-- Welcome Message -->
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <div class="ml-3 bg-gray-100 rounded-lg p-4 max-w-xl">
                        <p class="text-gray-800">Hello! I'm your Capital Projects Assistant. I can help you understand your portfolio. Try asking me:</p>
                        <ul class="mt-2 space-y-1 text-sm text-gray-600">
                            <li class="cursor-pointer hover:text-blue-600" onclick="askQuestion('Which projects are doing well?')">• "Which projects are doing well?"</li>
                            <li class="cursor-pointer hover:text-blue-600" onclick="askQuestion('What projects are at risk?')">• "What projects are at risk?"</li>
                            <li class="cursor-pointer hover:text-blue-600" onclick="askQuestion('Show me projects over budget')">• "Show me projects over budget"</li>
                            <li class="cursor-pointer hover:text-blue-600" onclick="askQuestion('What are your recommendations?')">• "What are your recommendations?"</li>
                            <li class="cursor-pointer hover:text-blue-600" onclick="askQuestion('Projects in District 3')">• "Projects in District 3"</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="p-4 border-t">
                <form id="chat-form" class="flex space-x-2">
                    <input type="text" id="chat-input"
                        class="flex-1 rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Ask about your projects..."
                        autocomplete="off">
                    <button type="submit"
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition flex items-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Stats Sidebar -->
    <div class="space-y-4">
        <!-- Portfolio Quick Stats -->
        <div class="bg-white rounded-lg shadow p-4">
            <h4 class="font-semibold text-gray-800 mb-3">Portfolio Snapshot</h4>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-gray-500">Total Projects</span>
                    <span class="font-semibold">{{ summary.total_projects }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-500">Program Value</span>
                    <span class="font-semibold">${{ '{:,.0f}'.format((summary.total_budget or 0) / 1000000) }}M</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-500">Avg Health Score</span>
                    <span class="font-semibold {% if (summary.avg_health_score or 0) >= 60 %}text-green-600{% elif (summary.avg_health_score or 0) >= 40 %}text-amber-600{% else %}text-red-600{% endif %}">
                        {{ '{:.0f}'.format(summary.avg_health_score or 0) }}
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-500">At Risk</span>
                    <span class="font-semibold {% if (summary.projects_at_risk or 0) > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                        {{ summary.projects_at_risk or 0 }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Quick Filters -->
        <div class="bg-white rounded-lg shadow p-4">
            <h4 class="font-semibold text-gray-800 mb-3">Quick Questions</h4>
            <div class="space-y-2">
                <button onclick="askQuestion('Give me a portfolio summary')" class="w-full text-left px-3 py-2 bg-gray-50 rounded hover:bg-blue-50 hover:text-blue-700 transition text-sm">
                    Portfolio Overview
                </button>
                <button onclick="askQuestion('Which projects are doing well?')" class="w-full text-left px-3 py-2 bg-gray-50 rounded hover:bg-blue-50 hover:text-blue-700 transition text-sm">
                    Healthy Projects
                </button>
                <button onclick="askQuestion('What projects need attention?')" class="w-full text-left px-3 py-2 bg-gray-50 rounded hover:bg-blue-50 hover:text-blue-700 transition text-sm">
                    Projects Needing Attention
                </button>
                <button onclick="askQuestion('Show projects behind schedule')" class="w-full text-left px-3 py-2 bg-gray-50 rounded hover:bg-blue-50 hover:text-blue-700 transition text-sm">
                    Schedule Issues
                </button>
                <button onclick="askQuestion('Show projects over budget')" class="w-full text-left px-3 py-2 bg-gray-50 rounded hover:bg-blue-50 hover:text-blue-700 transition text-sm">
                    Budget Issues
                </button>
                <button onclick="askQuestion('What are your recommendations?')" class="w-full text-left px-3 py-2 bg-gray-50 rounded hover:bg-blue-50 hover:text-blue-700 transition text-sm">
                    Get Recommendations
                </button>
            </div>
        </div>

        <!-- Status Distribution -->
        <div class="bg-white rounded-lg shadow p-4">
            <h4 class="font-semibold text-gray-800 mb-3">By Status</h4>
            <div class="space-y-2">
                <button onclick="askQuestion('Show advance projects')" class="w-full flex justify-between items-center px-3 py-2 bg-green-50 rounded hover:bg-green-100 transition">
                    <span class="text-green-700">Advance</span>
                    <span class="font-semibold text-green-700">{{ summary.advance_count or 0 }}</span>
                </button>
                <button onclick="askQuestion('Show monitor projects')" class="w-full flex justify-between items-center px-3 py-2 bg-amber-50 rounded hover:bg-amber-100 transition">
                    <span class="text-amber-700">Monitor</span>
                    <span class="font-semibold text-amber-700">{{ summary.monitor_count or 0 }}</span>
                </button>
                <button onclick="askQuestion('Show re-scope projects')" class="w-full flex justify-between items-center px-3 py-2 bg-orange-50 rounded hover:bg-orange-100 transition">
                    <span class="text-orange-700">Re-scope</span>
                    <span class="font-semibold text-orange-700">{{ summary.rescope_count or 0 }}</span>
                </button>
                <button onclick="askQuestion('Show defer projects')" class="w-full flex justify-between items-center px-3 py-2 bg-gray-50 rounded hover:bg-gray-100 transition">
                    <span class="text-gray-700">Defer</span>
                    <span class="font-semibold text-gray-700">{{ summary.defer_count or 0 }}</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    // Add user message to chat
    function addUserMessage(text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'flex items-start justify-end';
        msgDiv.innerHTML = `
            <div class="bg-blue-600 text-white rounded-lg p-4 max-w-xl">
                <p>${escapeHtml(text)}</p>
            </div>
            <div class="flex-shrink-0 w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center ml-3">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
            </div>
        `;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Add assistant message to chat
    function addAssistantMessage(response) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'flex items-start';

        let projectsHtml = '';
        if (response.projects && response.projects.length > 0) {
            projectsHtml = `
                <div class="mt-3 space-y-2">
                    ${response.projects.slice(0, 5).map(p => `
                        <a href="/project/${p['Project ID']}" class="block p-2 bg-white rounded border hover:border-blue-400 transition">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-gray-800">${p['Project Name']}</span>
                                <span class="text-sm ${getHealthColor(p['Project Health Score'])}">${Math.round(p['Project Health Score'] || 0)}</span>
                            </div>
                            <div class="text-xs text-gray-500">${p['Current Phase']} | $${(p['Total Budget']/1e6).toFixed(1)}M</div>
                        </a>
                    `).join('')}
                </div>
            `;
        }

        let keyPointsHtml = '';
        if (response.key_points && response.key_points.length > 0) {
            keyPointsHtml = `
                <ul class="mt-3 space-y-1 text-sm">
                    ${response.key_points.map(point => `<li class="text-gray-700">${point}</li>`).join('')}
                </ul>
            `;
        }

        let followUpHtml = '';
        if (response.follow_up_prompt) {
            followUpHtml = `
                <p class="mt-3 text-sm text-blue-600 cursor-pointer hover:underline" onclick="askQuestion('${escapeHtml(response.follow_up_prompt.replace(/\?.*$/, '?'))}')">
                    ${response.follow_up_prompt}
                </p>
            `;
        }

        let viewMoreHtml = '';
        if (response.projects && response.projects.length > 0) {
            const params = new URLSearchParams(response.filter_params || {}).toString();
            viewMoreHtml = `
                <a href="/filtered-view?${params}" class="inline-block mt-3 text-sm text-white bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 transition">
                    View All in Dashboard
                </a>
            `;
        }

        msgDiv.innerHTML = `
            <div class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
            </div>
            <div class="ml-3 bg-gray-100 rounded-lg p-4 max-w-xl">
                <p class="text-gray-800">${response.message}</p>
                ${keyPointsHtml}
                ${projectsHtml}
                ${followUpHtml}
                ${viewMoreHtml}
            </div>
        `;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Add loading indicator
    function addLoadingIndicator() {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-indicator';
        loadingDiv.className = 'flex items-start';
        loadingDiv.innerHTML = `
            <div class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-white animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <div class="ml-3 bg-gray-100 rounded-lg p-4">
                <p class="text-gray-500">Analyzing your portfolio...</p>
            </div>
        `;
        chatMessages.appendChild(loadingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Remove loading indicator
    function removeLoadingIndicator() {
        const loading = document.getElementById('loading-indicator');
        if (loading) loading.remove();
    }

    // Get health score color class
    function getHealthColor(score) {
        if (score >= 60) return 'text-green-600';
        if (score >= 40) return 'text-amber-600';
        return 'text-red-600';
    }

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Send chat message
    async function sendMessage(query) {
        addUserMessage(query);
        addLoadingIndicator();

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });

            removeLoadingIndicator();

            if (response.ok) {
                const data = await response.json();
                addAssistantMessage(data);
            } else {
                addAssistantMessage({
                    message: "Sorry, I encountered an error processing your request. Please try again.",
                    key_points: [],
                    projects: []
                });
            }
        } catch (error) {
            removeLoadingIndicator();
            addAssistantMessage({
                message: "Sorry, I couldn't connect to the server. Please check your connection.",
                key_points: [],
                projects: []
            });
        }
    }

    // Handle form submit
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const query = chatInput.value.trim();
        if (query) {
            sendMessage(query);
            chatInput.value = '';
        }
    });

    // Quick question function
    function askQuestion(question) {
        chatInput.value = question;
        sendMessage(question);
        chatInput.value = '';
    }
</script>
{% endblock %}
